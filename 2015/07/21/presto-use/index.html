<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="Presto查询引擎是一个Master-Slave的架构，由一个Coordinator节点，一个Discovery Server节点，多个Worker节点组成，Discovery Server通常内嵌于Coordinator节点中。">




  <meta name="keywords" content="SQL,">





  <link rel="alternate" href="/atom.xml" title="WHOAMI">




  <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/itweet/itweet.github.io/master/favicon.ico?v=1.1">



<link rel="canonical" href="http://itweet.github.io/2015/07/21/presto-use/">


<meta name="description" content="Presto查询引擎是一个Master-Slave的架构，由一个Coordinator节点，一个Discovery Server节点，多个Worker节点组成，Discovery Server通常内嵌于Coordinator节点中。">
<meta name="keywords" content="SQL">
<meta property="og:type" content="article">
<meta property="og:title" content="presto-use">
<meta property="og:url" content="http://itweet.github.io/2015/07/21/presto-use/index.html">
<meta property="og:site_name" content="WHOAMI">
<meta property="og:description" content="Presto查询引擎是一个Master-Slave的架构，由一个Coordinator节点，一个Discovery Server节点，多个Worker节点组成，Discovery Server通常内嵌于Coordinator节点中。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.itweet.cn/screenshots/presto.png">
<meta property="og:image" content="https://www.itweet.cn/screenshots/show-presto.png">
<meta property="og:image" content="https://www.itweet.cn/screenshots/presto.png">
<meta property="og:image" content="https://www.itweet.cn/screenshots/airpal-ui.png">
<meta property="og:image" content="https://www.itweet.cn/screenshots/function-color.png">
<meta property="og:updated_time" content="2019-03-03T09:22:32.306Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="presto-use">
<meta name="twitter:description" content="Presto查询引擎是一个Master-Slave的架构，由一个Coordinator节点，一个Discovery Server节点，多个Worker节点组成，Discovery Server通常内嵌于Coordinator节点中。">
<meta name="twitter:image" content="https://www.itweet.cn/screenshots/presto.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> presto-use - WHOAMI </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">WHOAMI</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/atom.xml">
                            
                            
                                RSS
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          presto-use
        
      </h1>

      <time class="post-time">
          7月 21 2015
      </time>
    </header>



    
            <div class="post-content">
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Facebook的数据仓库存储在少量大型Hadoop/HDFS集群。Hive是Facebook在几年前专为Hadoop打造的一款数据仓库工具。在以前，Facebook的科学家和分析师一直依靠Hive来做数据分析。但Hive使用MapReduce作为底层计算框架，是专为批处理设计的。但随着数据越来越多，使用Hive进行一个简单的数据查询可能要花费几分到几小时，显然不能满足交互式查询的需求。Facebook也调研了其他比Hive更快的工具，但它们要么在功能有所限制要么就太简单，以至于无法操作Facebook庞大的数据仓库。</p>
<p>2012年开始试用的一些外部项目都不合适，他们决定自己开发，这就是Presto。2012年秋季开始开发，目前该项目已经在超过 1000名Facebook雇员中使用，运行超过30000个查询，每日数据在1PB级别。Facebook称Presto的性能比Hive要好上10倍多。2013年Facebook正式宣布开源Presto。</p>
<p><img src="https://www.itweet.cn/screenshots/presto.png" alt></p>
<p>Presto查询引擎是一个Master-Slave的架构，由一个Coordinator节点，一个Discovery Server节点，多个Worker节点组成，Discovery Server通常内嵌于Coordinator节点中。Coordinator负责解析SQL语句，生成执行计划，分发执行任务给Worker节点执行。Worker节点负责实际执行查询任务。Worker节点启动后向Discovery Server服务注册，Coordinator从Discovery Server获得可以正常工作的Worker节点。如果配置了Hive Connector，需要配置一个Hive MetaStore服务为Presto提供Hive元信息，Worker节点与HDFS交互读取数据。</p>
<p>*特点</p>
<ul>
<li>完全基于内存的并行计算</li>
<li>流水线</li>
<li>本地化计算</li>
<li>动态编译执行计划</li>
<li>小心使用内存和数据结构</li>
<li>类BlinkDB的近似查询</li>
<li>GC控制</li>
</ul>
<p>*提交查询</p>
<blockquote>
<p>用户使用Presto Cli提交一个查询语句后，Cli使用HTTP协议与Coordinator通信，Coordinator收到查询请求后调用SqlParser解析SQL语句得到Statement对象，并将Statement封装成一个QueryStarter对象放入线程池中等待执行。</p>
</blockquote>
<p><img src="https://www.itweet.cn/screenshots/show-presto.png" alt></p>
<blockquote>
<p><a href="http://showterm.io/" target="_blank" rel="noopener">http://showterm.io/</a></p>
</blockquote>
<h1 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h1><p>基本要求:</p>
<ul>
<li>Linux or Mac OS X</li>
<li>Java 8, 64-bit</li>
<li>Python 2.4+</li>
</ul>
<h1 id="HADOOP-HIVE"><a href="#HADOOP-HIVE" class="headerlink" title="HADOOP / HIVE"></a>HADOOP / HIVE</h1><p>Presto supports reading Hive data from the following versions of Hadoop:</p>
<ul>
<li>Apache Hadoop 1.x</li>
<li>Apache Hadoop 2.x</li>
<li>Cloudera CDH 4</li>
<li>Cloudera CDH 5</li>
<li>The following file formats are supported: Text, SequenceFile, RCFile, ORC</li>
</ul>
<p>Additionally, a remote Hive metastore is required. Local or embedded mode is not supported. Presto does not use MapReduce and thus only requires HDFS.</p>
<h1 id="CASSANDRA"><a href="#CASSANDRA" class="headerlink" title="CASSANDRA"></a>CASSANDRA</h1><p>Cassandra 2.x is required. This connector is completely independent of the Hive connector and only requires an existing Cassandra installation.</p>
<h1 id="TPC-H"><a href="#TPC-H" class="headerlink" title="TPC-H"></a>TPC-H</h1><p>The TPC-H connector dynamically generates data that can be used for experiementing with and testing Presto. This connector has no external requirements.</p>
<h1 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h1><h2 id="一、安装和部署Presto"><a href="#一、安装和部署Presto" class="headerlink" title="一、安装和部署Presto"></a>一、安装和部署Presto</h2><h3 id="1、安装环境"><a href="#1、安装环境" class="headerlink" title="1、安装环境"></a>1、安装环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 操作系统</span><br><span class="line">CentOS release 6.5 (Final)</span><br><span class="line">2.6.32-431.el6.x86_64 #1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64  GNU/Linux</span><br><span class="line"></span><br><span class="line"># Hadoop版本</span><br><span class="line">Hadoop 2.4.0</span><br><span class="line"></span><br><span class="line"># hive版本</span><br><span class="line">hive-0.13.1</span><br><span class="line"></span><br><span class="line">#XXk版本</span><br><span class="line">java version &quot;1.8.0_45&quot;</span><br><span class="line">export PATH=.:$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$CLASSPATH</span><br></pre></td></tr></table></figure>
<h3 id="2、presto架构"><a href="#2、presto架构" class="headerlink" title="2、presto架构"></a>2、presto架构</h3><p><img src="https://www.itweet.cn/screenshots/presto.png" alt></p>
<p>上图可以看到，需要依赖hivemetastor服务，访问hive里面的表！所以一定需要安装hive并且启动hivemetasotre服务！</p>
<h3 id="3、安装presto"><a href="#3、安装presto" class="headerlink" title="3、安装presto"></a>3、安装presto</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">https://prestodb.io/docs/current/installation.html</span><br><span class="line">https://repo1.maven.org/maven2/com/facebook/presto/presto-server/0.100/presto-server-0.100.tar.gz</span><br><span class="line"></span><br><span class="line">#解压</span><br><span class="line">tar -zxvf presto-server-0.103.tar.gz</span><br><span class="line"></span><br><span class="line">#创建软连接</span><br><span class="line">ln -s presto-server-0.103 presto</span><br><span class="line"></span><br><span class="line">#解压后目录</span><br><span class="line">[root@server1 presto]# tree -L 2 </span><br><span class="line">.</span><br><span class="line">|-- NOTICE</span><br><span class="line">|-- README.txt</span><br><span class="line">|-- bin</span><br><span class="line">|   |-- launcher</span><br><span class="line">|   |-- launcher.properties</span><br><span class="line">|   |-- launcher.py</span><br><span class="line">|   `-- procname</span><br><span class="line">|-- lib</span><br><span class="line">|   |-- aether-api-1.13.1.jar</span><br><span class="line">|   |-- ………</span><br><span class="line">`-- plugin</span><br><span class="line">    |-- cassandra</span><br><span class="line">    |-- example-http</span><br><span class="line">    |-- hive-cdh4</span><br><span class="line">    |-- hive-cdh5</span><br><span class="line">    |-- hive-hadoop1</span><br><span class="line">    |-- hive-hadoop2</span><br><span class="line">    |-- kafka</span><br><span class="line">    |-- ml</span><br><span class="line">    |-- mysql</span><br><span class="line">    |-- postgresql</span><br><span class="line">    |-- raptor</span><br><span class="line">    `-- tpch</span><br><span class="line"></span><br><span class="line">Plugin中可以看到支持hadoop1,hadoop2,cdh5,cdh4这些插件，下面我们用到的是hive-hadoop2</span><br></pre></td></tr></table></figure>
<h3 id="4-配置-Presto"><a href="#4-配置-Presto" class="headerlink" title="4. 配置 Presto"></a>4. 配置 Presto</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在presto-server-0.100里面创建etc目录，并创建以下文件：</span><br><span class="line">node.properties：每个节点的环境配置</span><br><span class="line">jvm.config：jvm 参数</span><br><span class="line">config.properties：配置 Presto Server 参数</span><br><span class="line">log.properties：配置日志等级</span><br><span class="line">Catalog Properties：Catalog 的配置</span><br></pre></td></tr></table></figure>
<h4 id="1-etc-node-properties-示例配置如下"><a href="#1-etc-node-properties-示例配置如下" class="headerlink" title="(1).etc/node.properties 示例配置如下"></a>(1).etc/node.properties 示例配置如下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">node.environment=production</span><br><span class="line">node.id=5b47019c-a05c-42a5-9f9c-f17dbe27b42a #这个值必须是唯一的</span><br><span class="line">node.data-dir=/usr/local/presto/data</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line">node.environment：环境名称。一个集群节点中的所有节点的名称应该保持一致。</span><br><span class="line">node.id：节点唯一标识的名称。这里使用uuidgen生成。</span><br><span class="line">node.data-dir：数据和日志存放路径。</span><br></pre></td></tr></table></figure>
<h4 id="2-etc-jvm-config-示例配置如下"><a href="#2-etc-jvm-config-示例配置如下" class="headerlink" title="(2).etc/jvm.config 示例配置如下"></a>(2).etc/jvm.config 示例配置如下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-server</span><br><span class="line">-Xmx16G</span><br><span class="line">-XX:+UseConcMarkSweepGC</span><br><span class="line">-XX:+ExplicitGCInvokesConcurrent</span><br><span class="line">-XX:+CMSClassUnloadingEnabled</span><br><span class="line">-XX:+AggressiveOpts</span><br><span class="line">-XX:+HeapDumpOnOutOfMemoryError</span><br><span class="line">-XX:OnOutOfMemoryError=kill -9 %p</span><br><span class="line">-XX:ReservedCodeCacheSize=150M</span><br><span class="line">#-Xbootclasspath/p:/home/hsu/presto/lib/floatingdecimal-0.1.jar,1.7打patch,1.8不在需要！</span><br><span class="line">-Djava.library.path=/opt/cloudera/parcels/CDH-5.2.0-1.cdh5.2.0.p0.36/lib/hadoop-0.20-mapreduce/lib/native/Linux-amd64-64</span><br><span class="line"></span><br><span class="line">需要注意的是最后两行：</span><br><span class="line">/usr/local/presto/Linux-amd64-64：这是为了在Presto中支持LZO</span><br></pre></td></tr></table></figure>
<h4 id="3-etc-config-properties"><a href="#3-etc-config-properties" class="headerlink" title="(3).etc/config.properties"></a>(3).etc/config.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">etc/config.properties包含 Presto Server 相关的配置，每一个 Presto Server 可以同时作为 coordinator 和 worker 使用。你可以将他们配置在一个节点上，但是，在一个大的集群上建议分开配置以提高性能。</span><br><span class="line"></span><br><span class="line">coordinator 的最小配置：</span><br><span class="line">coordinator=true</span><br><span class="line">node-scheduler.include-coordinator=false</span><br><span class="line">http-server.http.port=9090</span><br><span class="line">task.max-memory=1GB</span><br><span class="line">discovery-server.enabled=true</span><br><span class="line">discovery.uri= http://server1:9090</span><br><span class="line"></span><br><span class="line">worker 的最小配置：</span><br><span class="line">coordinator=false</span><br><span class="line">http-server.http.port=9090</span><br><span class="line">task.max-memory=1GB</span><br><span class="line">discovery.uri= http://server1:9090</span><br><span class="line"></span><br><span class="line">可选的，作为测试，你可以在一个节点上同时配置两者：</span><br><span class="line">coordinator=true</span><br><span class="line">node-scheduler.include-coordinator=true</span><br><span class="line">http-server.http.port=9090</span><br><span class="line">task.max-memory=1GB</span><br><span class="line">discovery-server.enabled=true</span><br><span class="line">discovery.uri=http://server1:9090</span><br><span class="line"></span><br><span class="line">参数说明：</span><br><span class="line">coordinator：Presto 实例是否以 coordinator 对外提供服务</span><br><span class="line">node-scheduler.include-coordinator：是否允许在 coordinator 上进行调度任务</span><br><span class="line">http-server.http.port：HTTP 服务的端口</span><br><span class="line">task.max-memory=1GB：每一个任务（对应一个节点上的一个查询计划）所能使用的最大内存</span><br><span class="line">discovery-server.enabled：是否使用 Discovery service 发现集群中的每一个节点。</span><br><span class="line">discovery.uri：Discovery server 的 url</span><br></pre></td></tr></table></figure>
<h4 id="4-etc-log-properties"><a href="#4-etc-log-properties" class="headerlink" title="(4).etc/log.properties"></a>(4).etc/log.properties</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">etc/log.properties 可以设置某一个 java 包的日志等级：</span><br><span class="line"></span><br><span class="line">com.facebook.presto=INFO</span><br><span class="line"></span><br><span class="line">关于 Catalog 的配置，首先需要创建 etc/catalog 目录，然后根据你想使用的连接器来创建对应的配置文件，比如，你想使用 jmx 连接器，则创建 jmx.properties：</span><br><span class="line"></span><br><span class="line">connector.name=jmx</span><br><span class="line"></span><br><span class="line">如果你想使用 hive 的连接器，则创建 hive.properties：</span><br><span class="line">connector.name=hive-hadoop2</span><br><span class="line">hive.metastore.uri=thrift://server2:9083  #修改为 hive-metastore 服务所在的主机名称，这里我是安装在 server2节点</span><br><span class="line">hive.config.resources=/usr/local/hadoop-2.4.0/etc/hadoop/core-site.xml, /usr/local/hadoop-2.4.0/etc/hadoop/hdfs-site.xml</span><br><span class="line">hive.allow-drop-table=true  #允许删除hive表</span><br><span class="line"></span><br><span class="line">更多关于连接器的说明，请参考 http://prestodb.io/docs/current/connector.html。</span><br><span class="line"></span><br><span class="line">通过以上的四步，Coordinator已经设置完毕。</span><br></pre></td></tr></table></figure>
<h4 id="5-配置worker节点"><a href="#5-配置worker节点" class="headerlink" title="(5).配置worker节点"></a>(5).配置worker节点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">所有的配置的目录结构都是一样的，只需要修改上述的两个文件就可以达成Workers上的统一配置：</span><br><span class="line"></span><br><span class="line">scp -rq presto server3:/usr/local/</span><br><span class="line"></span><br><span class="line">修改第一个文件：config.properties：</span><br><span class="line">coordinator=false  </span><br><span class="line">http-server.http.port=9090  </span><br><span class="line">task.max-memory=1GB  </span><br><span class="line">discovery.uri=http://server1:9090  </span><br><span class="line"></span><br><span class="line">我们看到，作为Worker节点，已经将coordinator禁用掉：coordinator=false；</span><br><span class="line">PrestoServer的监听地址，还是9090端口；</span><br><span class="line">单任务内存数还是1GB；</span><br><span class="line">指向我们的DiscoveryServer：discovery.uri= http://server1:9090</span><br><span class="line"></span><br><span class="line">修改第二个文件：node.properties</span><br><span class="line">node.environment=production  </span><br><span class="line">node.id=c0550bd7-fcc2-407d-bfda-b1f26fb341b0  </span><br><span class="line">node.data-dir=/usr/local/presto/data  </span><br><span class="line"></span><br><span class="line">除了node.id的配置修改外，其它都保持一致即可，这个ID需要每个节点都不同，所以，这个不能简单的拷贝到其它Worker节点上，而要在每个节点上都修改成一个独一无二的值，我这里是通过uuidgen这个命令来生成的这个串。</span><br></pre></td></tr></table></figure>
<h4 id="6-添加对LZO的支持"><a href="#6-添加对LZO的支持" class="headerlink" title="(6). 添加对LZO的支持"></a>(6). 添加对LZO的支持</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1. 我们需要在每个Presto节点上的对应的插件目录下，放置hadoop-lzo.jar文件，以使其运行时可以加载到相关类：</span><br><span class="line"></span><br><span class="line">cd /usr/local/presto/plugin/hive-hadoop2 </span><br><span class="line">scp -r hadoop-lzo.jar itr-node0x:/usr/local/presto/plugin/hive-hadoop  </span><br><span class="line"></span><br><span class="line">2. JVM启动参数中，添加如下参数：</span><br><span class="line">-Djava.library.path=/usr/local/presto/Linux-amd64-64</span><br><span class="line"></span><br><span class="line">这样，HDFS中的LZO文件就可以正常访问到了。</span><br></pre></td></tr></table></figure>
<h4 id="7-关于性能的一些测试经验"><a href="#7-关于性能的一些测试经验" class="headerlink" title="(7). 关于性能的一些测试经验"></a>(7). 关于性能的一些测试经验</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果不禁止Coordinator上运行任务（node-scheduler.include-coordinator=false），那么性能的降低也非常明显。</span><br><span class="line">node-scheduler.include-coordinator：是否允许在coordinator服务中进行调度工作。对于大型的集群，在一个节点上的Presto server即作为coordinator又作为worke将会降低查询性能。因为如果一个服务器作为worker使用，那么大部分的资源都不会被worker占用，那么就不会有足够的资源进行关键任务调度、管理和监控查询执行。</span><br></pre></td></tr></table></figure>
<h3 id="5、连接器配置"><a href="#5、连接器配置" class="headerlink" title="5、连接器配置"></a>5、连接器配置</h3><h4 id="5-1-presto支持的连接器"><a href="#5-1-presto支持的连接器" class="headerlink" title="5.1 presto支持的连接器"></a>5.1 presto支持的连接器</h4><ul>
<li>(1). Black Hole Connector</li>
<li>(2). Cassandra Connector</li>
<li>(3)·. Hive Connector</li>
<li>(4). JMX Connector</li>
<li>(5). Kafka Connector</li>
<li>(6). Kafka Connector Tutorial</li>
<li>(7). MySQL Connector</li>
<li>(8). PostgreSQL Connector</li>
<li>(9). System Connector</li>
<li>(10). TPCH Connector  </li>
</ul>
<h4 id="5-2-hive"><a href="#5-2-hive" class="headerlink" title="5.2 hive"></a>5.2 hive</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">关于 Catalog 的配置，首先需要创建 etc/catalog 目录，然后根据你想使用的连接器来创建对应的配置文件，比如，你想使用 jmx 连接器，则创建 jmx.properties：</span><br><span class="line"></span><br><span class="line">connector.name=jmx</span><br><span class="line"></span><br><span class="line">如果你想使用 hive 的连接器，则创建 hive.properties：</span><br><span class="line">connector.name=hive-hadoop2</span><br><span class="line">hive.metastore.uri=thrift://server2:9083  #修改为 hive-metastore 服务所在的主机名称，这里我是安装在 server2节点</span><br><span class="line">hive.config.resources=/usr/local/hadoop-2.4.0/etc/hadoop/core-site.xml, /usr/local/hadoop-2.4.0/etc/hadoop/hdfs-site.xml</span><br><span class="line">hive.allow-drop-table=true  #允许删除hive表</span><br><span class="line"></span><br><span class="line">更多关于连接器的说明，请参考 http://prestodb.io/docs/current/connector.html。</span><br></pre></td></tr></table></figure>
<h4 id="5-3-mysql"><a href="#5-3-mysql" class="headerlink" title="5.3 mysql"></a>5.3 mysql</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">$ cat mysql.properties </span><br><span class="line">connector.name=mysql</span><br><span class="line">connection-url=XXbc:mysql://server1:3306</span><br><span class="line">connection-user=root</span><br><span class="line">connection-password=admin</span><br><span class="line"></span><br><span class="line">$ /home/hsu/presto/bin/presto-cli --server server1:9090 --catalog mysql --schema mysql;</span><br><span class="line">presto:mysql&gt; SHOW TABLES FROM mysql.hive;</span><br><span class="line"></span><br><span class="line">presto:default&gt; SHOW SCHEMAS;</span><br><span class="line">presto:default&gt; use hive;</span><br><span class="line">presto:hive&gt; show tables;</span><br><span class="line"></span><br><span class="line">$ /home/hsu/presto-server-0.103/bin/presto-cli --server server1:9090 --catalog mysql --schema airpal</span><br><span class="line">presto:default&gt; SHOW SCHEMAS;</span><br><span class="line">       Schema       </span><br><span class="line">--------------------</span><br><span class="line"> airpal  </span><br><span class="line"></span><br><span class="line">presto:default&gt; show catalogs;</span><br><span class="line"> Catalog </span><br><span class="line">---------</span><br><span class="line"> hive    </span><br><span class="line"> system  </span><br><span class="line"> jmx     </span><br><span class="line"> mysql   </span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line">如果遇到查看mysql数据</span><br><span class="line">presto:airpal&gt; select * from jobs;</span><br><span class="line">Query 20150521_062342_00051_ueeai failed: No nodes available to run query</span><br><span class="line">1、检查mysql是否在presto的主节点</span><br><span class="line">2、检查主节点配置文件cat config.properties是否配置node-scheduler.include-coordinator=false，打开即可解决</span><br><span class="line">3、禁止了主节点worker，那就无法读取到mysql数据！</span><br><span class="line"></span><br><span class="line">#写数据mysql到hive</span><br><span class="line">presto:default&gt; show catalogs;</span><br><span class="line"> Catalog </span><br><span class="line">---------</span><br><span class="line"> hive    </span><br><span class="line"> system  </span><br><span class="line"> jmx     </span><br><span class="line"> tpch    </span><br><span class="line"> mysql   </span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">presto:default&gt; create table hive.default.jobs as select * from mysql.airpal.jobs;</span><br><span class="line">CREATE TABLE: 10 rows</span><br><span class="line"></span><br><span class="line">Query 20150521_083025_00038_z2qr2, FINISHED, 2 nodes</span><br><span class="line">Splits: 3 total, 3 done (100.00%)</span><br><span class="line">0:03 [10 rows, 0B] [3 rows/s, 0B/s]</span><br><span class="line">presto:default&gt; select count(1) from jobs;</span><br><span class="line"> _col0 </span><br><span class="line">-------</span><br><span class="line">    10 </span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
<h4 id="5-4-kafka"><a href="#5-4-kafka" class="headerlink" title="5.4 kafka"></a>5.4 kafka</h4><p>这里主要参考官网实现：<a href="https://prestodb.io/docs/current/connector/kafka-tutorial.html" target="_blank" rel="noopener">https://prestodb.io/docs/current/connector/kafka-tutorial.html</a></p>
<p>Step 1: Install Apache Kafka<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参考kafka安装文档</span><br></pre></td></tr></table></figure></p>
<p>Step 2: Make the Kafka topics known to Presto<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat kafka.properties </span><br><span class="line">connector.name=kafka</span><br><span class="line">kafka.nodes=server1:9092,server2:9092,server3:9092</span><br><span class="line">kafka.table-names=tpch.customer,tpch.orders,tpch.lineitem,tpch.part,tpch.partsupp,tpch.supplier,tpch.nation,tpch.region</span><br><span class="line">kafka.hide-internal-columns=false</span><br><span class="line">#需要重启集群</span><br></pre></td></tr></table></figure></p>
<p>Step 3: Load data<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://prestodb-china.com/docs/current/connector/kafka-tutorial.html</span><br><span class="line"></span><br><span class="line">$ curl -o kafka-tpch https://repo1.maven.org/maven2/de/softwareforge/kafka_tpch_0811/1.0/kafka_tpch_0811-1.0.sh</span><br><span class="line"></span><br><span class="line">$ mv kafka_tpch_0811-1.0.sh kafka_tpch</span><br><span class="line">$ chmod 775 kafka_tpch</span><br><span class="line">$ ./kafka_tpch load --brokers server1:9092 --prefix tpch. --tpch-type tiny</span><br></pre></td></tr></table></figure></p>
<p>Step 4: Basic data querying<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ ../bin/presto-cli --server server1:9090 --catalog kafka --schema tpch     </span><br><span class="line">presto:tpch&gt; show tables;</span><br><span class="line">  Table   </span><br><span class="line">----------</span><br><span class="line"> customer </span><br><span class="line"> lineitem </span><br><span class="line"> nation   </span><br><span class="line"> orders   </span><br><span class="line"> part     </span><br><span class="line"> partsupp </span><br><span class="line"> region   </span><br><span class="line"> supplier </span><br><span class="line">(8 rows)</span><br><span class="line"></span><br><span class="line">presto:tpch&gt;  DESCRIBE customer;</span><br><span class="line">      Column       |  Type   | Null | Partition Key |                   Comment</span><br><span class="line">-------------------+---------+------+---------------+---------------------------------------------</span><br><span class="line"> _partition_id     | bigint  | true | false         | Partition Id</span><br><span class="line"> _partition_offset | bigint  | true | false         | Offset for the message within the partition</span><br><span class="line"> _segment_start    | bigint  | true | false         | Segment start offset</span><br><span class="line"> _segment_end      | bigint  | true | false         | Segment end offset</span><br><span class="line"> _segment_count    | bigint  | true | false         | Running message count per segment</span><br><span class="line"> _key              | varchar | true | false         | Key text</span><br><span class="line"> _key_corrupt      | boolean | true | false         | Key data is corrupt</span><br><span class="line"> _key_length       | bigint  | true | false         | Total number of key bytes</span><br><span class="line"> _message          | varchar | true | false         | Message text</span><br><span class="line"> _message_corrupt  | boolean | true | false         | Message data is corrupt</span><br><span class="line"> _message_length   | bigint  | true | false         | Total number of message bytes</span><br><span class="line">(11 rows)</span><br><span class="line"></span><br><span class="line">presto:tpch&gt; SELECT _message FROM customer LIMIT 2;</span><br><span class="line">&#123;&quot;rowNumber&quot;:1,&quot;customerKey&quot;:1,&quot;name&quot;:&quot;Customer#000000001&quot;,&quot;address&quot;:&quot;IVhzIApeRb ot,c,E&quot;,&quot;nationKey&quot;:15,&quot;phone&quot;:&quot;25-989-741-2988&quot;,&quot;accountBalance&quot;:711.56,&quot;marketSegment&quot;:&quot;BUILDING&quot;,&quot;comment&quot;:&quot;to the even, regular platelets. regular, ironic epitaphs nag e&quot;&#125;</span><br><span class="line"> &#123;&quot;rowNumber&quot;:3,&quot;customerKey&quot;:3,&quot;name&quot;:&quot;Customer#000000003&quot;,&quot;address&quot;:&quot;MG9kdTD2WBHm&quot;,&quot;nationKey&quot;:1,&quot;phone&quot;:&quot;11-719-748-3364&quot;,&quot;accountBalance&quot;:7498.12,&quot;marketSegment&quot;:&quot;AUTOMOBILE&quot;,&quot;comment&quot;:&quot; deposits eat slyly ironic, even instructions. express foxes detect slyly. blithel</span><br><span class="line"> &#123;&quot;rowNumber&quot;:5,&quot;customerKey&quot;:5,&quot;name&quot;:&quot;Customer#000000005&quot;,&quot;address&quot;:&quot;KvpyuHCplrB84WgAiGV6sYpZq7Tj&quot;,&quot;nationKey&quot;:3,&quot;phone&quot;:&quot;13-750-942-6364&quot;,&quot;accountBalance&quot;:794.47,&quot;marketSegment&quot;:&quot;HOUSEHOLD&quot;,&quot;comment&quot;:&quot;n accounts will have to unwind. foxes cajole accor&quot;&#125;</span><br><span class="line"> &#123;&quot;rowNumber&quot;:7,&quot;customerKey&quot;:7,&quot;name&quot;:&quot;Customer#000000007&quot;,&quot;address&quot;:&quot;TcGe5gaZNgVePxU5kRrvXBfkasDTea&quot;,&quot;nationKey&quot;:18,&quot;phone&quot;:&quot;28-190-982-9759&quot;,&quot;accountBalance&quot;:9561.95,&quot;marketSegment&quot;:&quot;AUTOMOBILE&quot;,&quot;comment&quot;:&quot;ainst the ironic, express theodolites. express, even pinto bean</span><br><span class="line"> &#123;&quot;rowNumber&quot;:9,&quot;customerKey&quot;:9,&quot;name&quot;:&quot;Customer#000000009&quot;,&quot;address&quot;:&quot;xKiAFTjUsCuxfeleNqefumTrjS&quot;,&quot;nationKey&quot;:8,&quot;phone&quot;:&quot;18-338-906-3675&quot;,&quot;accountBalance&quot;:8324.07,&quot;marketSegment&quot;:&quot;FURNITURE&quot;,&quot;comment&quot;:&quot;r theodolites according to the requests wake thinly excuses: pending”&#125;</span><br><span class="line"></span><br><span class="line">presto:tpch&gt; SELECT sum(cast(json_extract_scalar(_message, &apos;$.accountBalance&apos;) AS double)) FROM customer LIMIT 10;</span><br><span class="line">       _col0       </span><br><span class="line">-------------------</span><br><span class="line"> 6681865.590000002</span><br></pre></td></tr></table></figure></p>
<h4 id="Step-5-Add-a-topic-decription-file"><a href="#Step-5-Add-a-topic-decription-file" class="headerlink" title="Step 5: Add a topic decription file"></a>Step 5: Add a topic decription file</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">etc/kafka/tpch.customer.json</span><br><span class="line">$ cat tpch.customer.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;tableName&quot;: &quot;customer&quot;,</span><br><span class="line">    &quot;schemaName&quot;: &quot;tpch&quot;,</span><br><span class="line">    &quot;topicName&quot;: &quot;tpch.customer&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;dataFormat&quot;: &quot;raw&quot;,</span><br><span class="line">        &quot;fields&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;kafka_key&quot;,</span><br><span class="line">                &quot;dataFormat&quot;: &quot;LONG&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;BIGINT&quot;,</span><br><span class="line">                &quot;hidden&quot;: &quot;false&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;message&quot;: &#123;</span><br><span class="line">        &quot;dataFormat&quot;: &quot;json&quot;,</span><br><span class="line">        &quot;fields&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;row_number&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;rowNumber&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;BIGINT&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;customer_key&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;customerKey&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;BIGINT&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;name&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;name&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;VARCHAR&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;address&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;address&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;VARCHAR&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;nation_key&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;nationKey&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;BIGINT&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;phone&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;phone&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;VARCHAR&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;account_balance&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;accountBalance&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;DOUBLE&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;market_segment&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;marketSegment&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;VARCHAR&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;name&quot;: &quot;comment&quot;,</span><br><span class="line">                &quot;mapping&quot;: &quot;comment&quot;,</span><br><span class="line">                &quot;type&quot;: &quot;VARCHAR&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ 重启集群</span><br><span class="line">$ presto/bin/presto-cli --server server1:9090 --catalog kafka --schema tpch</span><br><span class="line"></span><br><span class="line">presto:tpch&gt; DESCRIBE customer;</span><br><span class="line">      Column       |  Type   | Null | Partition Key |                   Comment</span><br><span class="line">-------------------+---------+------+---------------+---------------------------------------------</span><br><span class="line"> kafka_key         | bigint  | true | false         |</span><br><span class="line"> row_number        | bigint  | true | false         |</span><br><span class="line"> customer_key      | bigint  | true | false         |</span><br><span class="line"> name              | varchar | true | false         |</span><br><span class="line"> address           | varchar | true | false         |</span><br><span class="line"> nation_key        | bigint  | true | false         |</span><br><span class="line"> phone             | varchar | true | false         |</span><br><span class="line"> account_balance   | double  | true | false         |</span><br><span class="line"> market_segment    | varchar | true | false         |</span><br><span class="line"> comment           | varchar | true | false         |</span><br><span class="line"> _partition_id     | bigint  | true | false         | Partition Id</span><br><span class="line"> _partition_offset | bigint  | true | false         | Offset for the message within the partition</span><br><span class="line"> _segment_start    | bigint  | true | false         | Segment start offset</span><br><span class="line"> _segment_end      | bigint  | true | false         | Segment end offset</span><br><span class="line"> _segment_count    | bigint  | true | false         | Running message count per segment</span><br><span class="line"> _key              | varchar | true | false         | Key text</span><br><span class="line"> _key_corrupt      | boolean | true | false         | Key data is corrupt</span><br><span class="line"> _key_length       | bigint  | true | false         | Total number of key bytes</span><br><span class="line"> _message          | varchar | true | false         | Message text</span><br><span class="line"> _message_corrupt  | boolean | true | false         | Message data is corrupt</span><br><span class="line"> _message_length   | bigint  | true | false         | Total number of message bytes</span><br><span class="line">(21 rows)</span><br><span class="line"></span><br><span class="line">presto:tpch&gt;  SELECT * FROM customer LIMIT 5;</span><br><span class="line"> kafka_key | row_number | customer_key |        name        |                address                | nation_key |      phone      | account_balance | market_segment |                                                      comment</span><br><span class="line">-----------+------------+--------------+--------------------+---------------------------------------+------------+-----------------+-----------------+----------------+---------------------------------------------------------------------------------------------------------</span><br><span class="line">         1 |          2 |            2 | Customer#000000002 | XSTf4,NCwDVaWNe6tEgvwfmRchLXak        |         13 | 23-768-687-3665 |          121.65 | AUTOMOBILE     | l accounts. blithely ironic theodolites integrate boldly: caref</span><br><span class="line">         3 |          4 |            4 | Customer#000000004 | XxVSJsLAGtn                           |          4 | 14-128-190-5944 |         2866.83 | MACHINERY      |  requests. final, regular ideas sleep final accou</span><br><span class="line">         5 |          6 |            6 | Customer#000000006 | sKZz0CsnMD7mp4Xd0YrBvx,LREYKUWAh yVn  |         20 | 30-114-968-4951 |         7638.57 | AUTOMOBILE     | tions. even deposits boost according to the slyly bold packages. final accounts cajole requests. furious</span><br><span class="line">         7 |          8 |            8 | Customer#000000008 | I0B10bB0AymmC, 0PrRYBCP1yGJ8xcBPmWhl5 |         17 | 27-147-574-9335 |         6819.74 | BUILDING       | among the slyly regular theodolites kindle blithely courts. carefully even theodolites haggle slyly alon</span><br><span class="line">         9 |         10 |           10 | Customer#000000010 | 6LrEaV6KR6PLVcgl2ArL Q3rqzLzcT1 v2    |          5 | 15-741-346-9870 |         2753.54 | HOUSEHOLD      | es regular deposits haggle. fur</span><br><span class="line">(5 rows)</span><br><span class="line"></span><br><span class="line">presto:tpch&gt; SELECT sum(account_balance) FROM customer LIMIT 10;</span><br><span class="line">       _col0       </span><br><span class="line">-------------------</span><br><span class="line"> 6681865.590000002 </span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">presto:tpch&gt;  SELECT kafka_key FROM customer ORDER BY kafka_key LIMIT 10;</span><br><span class="line"> kafka_key </span><br><span class="line">-----------</span><br><span class="line">         0 </span><br><span class="line">         1 </span><br><span class="line">         2 </span><br><span class="line">         3 </span><br><span class="line">         4 </span><br><span class="line">         5 </span><br><span class="line">         6 </span><br><span class="line">         7 </span><br><span class="line">         8 </span><br><span class="line">         9 </span><br><span class="line">(10 rows)</span><br></pre></td></tr></table></figure>
<h4 id="5-5-System-Connector"><a href="#5-5-System-Connector" class="headerlink" title="5.5 System Connector"></a>5.5 System Connector</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">presto:default&gt; SHOW SCHEMAS FROM system;</span><br><span class="line">       Schema       </span><br><span class="line">--------------------</span><br><span class="line"> information_schema </span><br><span class="line"> metadata           </span><br><span class="line"> runtime</span><br><span class="line"></span><br><span class="line">presto:default&gt; SHOW TABLES FROM system.runtime;</span><br><span class="line">  Table  </span><br><span class="line">---------</span><br><span class="line"> nodes   </span><br><span class="line"> queries </span><br><span class="line"> tasks  </span><br><span class="line">presto:system&gt; use system.runtime;</span><br><span class="line">presto:runtime&gt; show tables;</span><br><span class="line">  Table  </span><br><span class="line">---------</span><br><span class="line"> nodes   </span><br><span class="line"> queries </span><br><span class="line"> tasks</span><br></pre></td></tr></table></figure>
<h3 id="6、启动Presto"><a href="#6、启动Presto" class="headerlink" title="6、启动Presto"></a>6、启动Presto</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server1 presto]# bin/launcher start</span><br><span class="line"></span><br><span class="line">bin/launcher start –v</span><br><span class="line"></span><br><span class="line">启动报错：</span><br><span class="line">Unsupported major.minor version 52.0，XXk需要1.8+</span><br><span class="line">tar -zxvf software/XXk-8u45-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line">主节点启动jps：bin/launcher start</span><br><span class="line">PrestoServer</span><br><span class="line">Worker启动：bin/launcher start</span><br><span class="line">PrestoServer</span><br></pre></td></tr></table></figure>
<h3 id="7、Command-Line-Interface"><a href="#7、Command-Line-Interface" class="headerlink" title="7、Command Line Interface"></a>7、Command Line Interface</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">测试 Presto CLI</span><br><span class="line">https://repo1.maven.org/maven2/com/facebook/presto/presto-cli/0.100/presto-cli-0.100-executable.jar</span><br><span class="line">Download presto-cli-0.100-executable.jar并将其重命名为 presto-cli（你也可以重命名为 presto），然后添加执行权限。</span><br><span class="line"></span><br><span class="line">mv presto-cli-0.100-executable.jar presto</span><br><span class="line">chmod +x presto</span><br><span class="line">./presto --server server1:9090 --catalog hive --schema default</span><br><span class="line">presto:default&gt; show tables;</span><br><span class="line">       Table        </span><br><span class="line">--------------------</span><br><span class="line"> order_test         </span><br><span class="line"> order_test_parquet</span><br><span class="line">可以运行 --help 命令查看更多参数，例如你可以在命令行直接运行下面命令：</span><br><span class="line">./presto --help</span><br><span class="line">./presto --server server1:9090 --catalog hive --schema default --execute &quot;show tables;&quot;</span><br><span class="line"></span><br><span class="line">默认情况下，Presto 的查询结果是使用 less 程序分页输出的，你可以通过修改环境变量 PRESTO_PAGER 的值将其改为其他命令，如 more，或者将其置为空以禁止分页输出。</span><br><span class="line"></span><br><span class="line">[hsu@server1 ~]$ cat engines/presto-sql-cli.sh </span><br><span class="line">/home/hsu/presto/bin/presto-cli --server server1:9090 --catalog hive --schema default</span><br></pre></td></tr></table></figure>
<h3 id="8-测试-XXbc"><a href="#8-测试-XXbc" class="headerlink" title="8. 测试 XXbc"></a>8. 测试 XXbc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://repo1.maven.org/maven2/com/facebook/presto/presto-jdbc/0.100/presto-jdbcbc-0.100.jar</span><br><span class="line">使用 jdbc 连接 Presto，需要下载 XXbc 驱动 presto-jdbc-0.100.jar并将其加到你的应用程序的 classpath 中。</span><br><span class="line"></span><br><span class="line">支持以下几种 JDBC URL 格式：</span><br><span class="line"></span><br><span class="line">jdbc:presto://host:port</span><br><span class="line">jdbc:presto://host:port/catalog</span><br><span class="line">jdbc:presto://host:port/catalog/schema</span><br><span class="line">连接 hive 数据库中 sales 库，示例如下：</span><br><span class="line"></span><br><span class="line">jdbc:presto: http://server1:9090/hive/sales</span><br></pre></td></tr></table></figure>
<h3 id="9-总结"><a href="#9-总结" class="headerlink" title="9. 总结"></a>9. 总结</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">本文主要记录 Presto 的安装部署过程，并使用 hive-hadoop2 连接器进行简单测试。下一步，需要基于一些生产数据做一些功能测试以及和 impala,spark-sql,hive 做一些对比测试。</span><br><span class="line"></span><br><span class="line">资料：http://tech.meituan.com/presto.html</span><br><span class="line">    http://prestodb.io/</span><br><span class="line">    http://www.dw4e.com/?p=141</span><br><span class="line">    http://wangmeng.us/notes/Impala/ #Impala Presto wiki 主要介绍了 Presto 的架构、原理和工作流程，以及和 impala 的对比。</span><br></pre></td></tr></table></figure>
<h2 id="二、orc优秀存储格式"><a href="#二、orc优秀存储格式" class="headerlink" title="二、orc优秀存储格式"></a>二、orc优秀存储格式</h2><blockquote>
<p><a href="https://code.facebook.com/posts/370832626374903/even-faster-data-at-the-speed-of-presto-orc/" target="_blank" rel="noopener">https://code.facebook.com/posts/370832626374903/even-faster-data-at-the-speed-of-presto-orc/</a><br>orc的自带，不需要添加jar包<br><a href="https://github.com/klbostee/hadoop-lzo" target="_blank" rel="noopener">https://github.com/klbostee/hadoop-lzo</a><br>这个编译了放到plugin下面的对应的hive-xxx目录下面，同步下应该就能用了</p>
</blockquote>
<p>#设置表格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set session hive.storage_format=&apos;RCBINARY&apos;</span><br><span class="line">set session hive.storage_format=&apos;RCTEXT&apos;</span><br><span class="line">set session hive.storage_format=&apos;ORC&apos;;</span><br><span class="line">set session hive.storage_format=&apos;PARQUET&apos;;</span><br></pre></td></tr></table></figure></p>
<h2 id="三、Presto全靠优化参数"><a href="#三、Presto全靠优化参数" class="headerlink" title="三、Presto全靠优化参数"></a>三、Presto全靠优化参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">presto:</span><br><span class="line">    官方默认存储格式是RCFile格式的，可以设置set session hive.storage_format=&apos;ORC&apos;;</span><br><span class="line">    XX:客户端就行了，先set session hive.storage_format=&apos;ORC&apos;;然后建的表就是ORC格式的了！</span><br><span class="line">    </span><br><span class="line">    XX:生成orc文件效率提升参数：</span><br><span class="line">    presto:test&gt; set session task_writer_count=&apos;8&apos;;</span><br><span class="line">    </span><br><span class="line">XX:cat jvm.config 我们这边 -Xmx120G</span><br><span class="line"></span><br><span class="line">XX: 出现数据倾斜：</span><br><span class="line">optimize_hash_generation,这个session 参数设置成true试下</span><br><span class="line">    presto:test&gt; set session optimize_hash_generation=&apos;true&apos;;</span><br><span class="line"></span><br><span class="line">    Presto生成orc表：</span><br><span class="line">    presto:default&gt; set session hive.storage_format=&apos;PARQUET&apos;;</span><br><span class="line">    presto:default&gt; create table test_parquet_test as select * from test_textfile;</span><br><span class="line">    presto:default&gt; set session hive.storage_format=&apos;ORC&apos;;</span><br><span class="line">    presto:test&gt; set session task_writer_count=&apos;8&apos;;</span><br><span class="line">    presto:test&gt; create table test_orc_test_presto as select * from test_textfile;</span><br><span class="line">hive (default)&gt; show create table test;</span><br><span class="line"></span><br><span class="line">#生成不同格式的表</span><br><span class="line">set session hive.storage_format=&apos;RCBINARY&apos;</span><br><span class="line">set session hive.storage_format=&apos;RCTEXT&apos;</span><br><span class="line">set session hive.storage_format=&apos;PARQUET&apos;;</span><br><span class="line">set session hive.storage_format=&apos;ORC&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="四、测试过程问题"><a href="#四、测试过程问题" class="headerlink" title="四、测试过程问题"></a>四、测试过程问题</h2><p>1、某些查询维度不合理导致数据倾斜，某些节点负载过大而失去联系出现问题！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">具体表现为：Query 20150507_013905_00017_3b8jn failed: Encountered too many errors talking to a worker node. The node may have crashed or be under too much load. This is probably a transient issue, so please retry your query in a few minutes.</span><br><span class="line">select * from system.runtime.nodes;语句发现某些节点和集群失去联系导致识别！</span><br><span class="line">解决：合理的查询维度，调优参数set session optimize_hash_generation=&apos;true&apos;;</span><br></pre></td></tr></table></figure></p>
<p>2、orc文件格式生成效率低下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">XX:生成orc文件效率提升参数：</span><br><span class="line">   presto:test&gt; set session task_writer_count=&apos;8&apos;;</span><br><span class="line"></span><br><span class="line">XX的生成orc就非常快，15个node，而我这里就算设置了调优参数，集群还是用了很长时间！就在硬件瓶颈上面！不同框架都有自己特定优化的格式，需要四组测试对比看，才能看到压缩空间情况！时间和空间是两难的抉择！XX：我们这边 -Xmx120G，set session task_writer_count=&apos;8&apos;, task.max-memory=30GB</span><br><span class="line"></span><br><span class="line">每个节点写线程增加为8个，默认是1个！</span><br></pre></td></tr></table></figure></p>
<p>3、presto目前无缓存功能<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">新版本可能会提供，已经有人在开发次模块还没合并到官方master版本中，而只是在分支中!</span><br></pre></td></tr></table></figure></p>
<p>4、presto计算节点失去联系,计算的orc结果文件非常巨大<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">presto:test&gt; select count(1) from (SELECT a, b, c,row_number() OVER (PARTITION BY a,b ORDER BY a DESC) AS rnk FROM test_orc_test_presto) a where a.rnk=1;</span><br><span class="line"></span><br><span class="line">Query 20150507_062202_00117_3b8jn, FAILED, 9 nodes</span><br><span class="line">Splits: 18 total, 0 done (0.00%)</span><br><span class="line">1:56 [88M rows, 1.27GB] [758K rows/s, 11.2MB/s]</span><br><span class="line"></span><br><span class="line">Query 20150507_062202_00117_3b8jn failed: Encountered too many errors talking to a worker node. The node may have crashed or be under too much load. This is probably a transient issue, so please retry your query in a few minutes. (http://135.33.5.63:9090/v1/task/20150507_062202_00117_3b8jn.2.1/results/20150507_062202_00117_3b8jn.1.6/864 - requests failed for 84.18s)</span><br><span class="line">presto:test&gt; set session optimize_hash_generation=&apos;true&apos;;</span><br><span class="line">SET SESSION</span><br><span class="line">presto:test&gt; set session optimize_hash_generation=&apos;false&apos;;</span><br><span class="line">SET SESSION</span><br><span class="line"></span><br><span class="line">针对orc格式的表关闭了此调优参数，顺利执行！排查发现orc文件很大</span><br><span class="line"></span><br><span class="line">需要控制生成更多比较小的orc结果文件！打一下这个patch，编译下presto-hive项目然后把presto-hive-0.100.jar替换了重启presto</span><br><span class="line">https://github.com/facebook/presto/pull/2655</span><br><span class="line"></span><br><span class="line">----</span><br><span class="line">目前我市0.100版本，而在0.101版本就已经修了此问题了！</span><br><span class="line">确实用hive生成的orc表可以解决！难道某些节点文件太大，导致计算节点失去联系吗？YES，自问自答！</span><br><span class="line"></span><br><span class="line">QQ答疑：</span><br><span class="line">Ph-XX:</span><br><span class="line">hive生成的orc文件有很多，而presto生成的orc文件数和worker一样！导致查询orc的时候，某些节点失去联系而任务失败！presto查询hive生成的orc表很快完成！无报错！是0.100生成orc表的策略问题吧！@XX-AA </span><br><span class="line"></span><br><span class="line">XX-AA 2015/5/13 9:34:40</span><br><span class="line">你可以设置task_write_count参数</span><br><span class="line">XX-AA 2015/5/13 9:35:17</span><br><span class="line">默认是1，也就是一个节点起一个write线程，也就是一个节点形成一个文件，如果这个参数设置多个，写的文件也会多</span><br><span class="line">XX-AA 2015/5/13 9:35:22</span><br><span class="line">写的效率也高</span><br></pre></td></tr></table></figure></p>
<p>5、针对hive优化参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hive.metastore-cache-ttl    etc/catalog/hive.properties hive元数据缓存的过期时间  default:1h</span><br><span class="line">hive.metastore-refresh-interval etc/catalog/hive.properties hive元数据缓存的刷新时间      default:1s</span><br><span class="line">optimizer.optimize-hash-generation  只需在Coordinator上etc/config.properties进行配置    表示是否启用对哈希聚合的优化，如果启用该选项，将会提升CPU使用率       default:FALSE</span><br><span class="line"></span><br><span class="line">SET SESSION optimize_hash_generation = &apos;true&apos;;</span><br><span class="line">SET SESSION hive.optimized_reader_enabled = &apos;true&apos;;</span><br></pre></td></tr></table></figure></p>
<h2 id="五、WEBUI界面"><a href="#五、WEBUI界面" class="headerlink" title="五、WEBUI界面"></a>五、WEBUI界面</h2><p><a href="https://github.com/itweet/airpal" target="_blank" rel="noopener">https://github.com/itweet/airpal</a>  </p>
<p><img src="https://www.itweet.cn/screenshots/airpal-ui.png" alt></p>
<p>git clone <a href="https://github.com/itweet/airpal.git" target="_blank" rel="noopener">https://github.com/itweet/airpal.git</a><br>./gradlew clean shadowJar  </p>
<p>配置后即可使用，参考文档进行！  </p>
<ul>
<li><p>Mysql创建库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select user,host from mysql.user\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">user: airpal</span><br><span class="line">host: %</span><br><span class="line">mysql&gt; create database airpal;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; grant all on airpal.* to &apos;airpal&apos;@&apos;%&apos; identified by &apos;airpal&apos;;             </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置reference文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[hsu@server1 airpal]$ cat reference.yml </span><br><span class="line"># Logging settings</span><br><span class="line">logging:</span><br><span class="line"></span><br><span class="line">  loggers:</span><br><span class="line">    org.apache.shiro: INFO</span><br><span class="line"></span><br><span class="line">  # The default level of all loggers. Can be OFF, ERROR, WARN, INFO, DEBUG, TRACE, or ALL.</span><br><span class="line">  level: INFO</span><br><span class="line"></span><br><span class="line"># HTTP-specific options.</span><br><span class="line">server:</span><br><span class="line">  applicationConnectors:</span><br><span class="line">    - type: http</span><br><span class="line">      port: 8081</span><br><span class="line">      idleTimeout: 10 seconds</span><br><span class="line"></span><br><span class="line">  adminConnectors:</span><br><span class="line">    - type: http</span><br><span class="line">      port: 8082</span><br><span class="line"></span><br><span class="line">shiro:</span><br><span class="line">  iniConfigs: [&quot;classpath:shiro_allow_all.ini&quot;]</span><br><span class="line"></span><br><span class="line">dataSourceFactory:</span><br><span class="line">  driverClass: com.mysql.jdbc.Driver</span><br><span class="line">  user: airpal</span><br><span class="line">  password: airpal</span><br><span class="line">  url: jdbc:mysql://127.0.0.1:3306/airpal</span><br><span class="line"></span><br><span class="line"># The URL to the Presto coordinator.</span><br><span class="line">prestoCoordinator: http://server1:9090</span><br></pre></td></tr></table></figure>
</li>
<li><p>migragte your database</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hsu@server1 airpal]$ java -Duser.timezone=UTC -cp build/libs/airpal-0.1.0-SNAPSHOT-all.jar com.airbnb.airpal.AirpalApplication db migrate reference.yml</span><br><span class="line">INFO  [2015-05-11 03:50:19,945] org.flywaydb.core.internal.command.DbMigrate: Successfully applied 5 migrations to schema `airpal` (execution time 00:01.568s).</span><br><span class="line"></span><br><span class="line">[hsu@server1 airpal]$ java -server -Duser.timezone=UTC -cp build/libs/airpal-0.1.0-SNAPSHOT-all.jar com.airbnb.airpal.AirpalApplication server reference.yml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="六、TPC-H"><a href="#六、TPC-H" class="headerlink" title="六、TPC-H"></a>六、TPC-H</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">http://prestodb-china.com/docs/current/installation/benchmark-driver.html</span><br><span class="line">https://repo1.maven.org/maven2/com/facebook/presto/presto-benchmark-driver/0.103/presto-benchmark-driver-0.103-executable.jar</span><br><span class="line"></span><br><span class="line">$ mv presto-benchmark-driver-0.103-executable.jar presto-benchmark-driver</span><br><span class="line">$ chmod +x presto-benchmark-driver</span><br><span class="line"></span><br><span class="line">[hsu@server1 test]$ ls</span><br><span class="line">presto-benchmark-driver</span><br><span class="line"></span><br><span class="line">$ cat suite.json </span><br><span class="line">&#123;</span><br><span class="line">    &quot;file_formats&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: [&quot;single_.*&quot;, &quot;tpch_.*&quot;],</span><br><span class="line">        &quot;schema&quot;: [ &quot;tpch_sf(?&lt;scale&gt;.*)_(?&lt;format&gt;.*)_(?&lt;compression&gt;.*?)&quot; ]</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;legacy_orc&quot;: &#123;</span><br><span class="line">        &quot;query&quot;: [&quot;single_.*&quot;, &quot;tpch_.*&quot;],</span><br><span class="line">        &quot;schema&quot;: [ &quot;tpch_sf(?&lt;scale&gt;.*)_(?&lt;format&gt;orc)_(?&lt;compression&gt;.*?)&quot; ],</span><br><span class="line">        &quot;session&quot;: &#123;</span><br><span class="line">            &quot;hive.optimized_reader_enabled&quot;: &quot;false&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#开始测试，木有成功</span><br><span class="line">[hsu@server1 test]$ sh presto-benchmark-driver --server server1:9090 --catalog tpch--schema default</span><br><span class="line"></span><br><span class="line">https://prestodb.io/docs/current/connector/tpch.html</span><br><span class="line">$ cat tpch.properties </span><br><span class="line">connector.name=tpch</span><br><span class="line">$ /home/hsu/presto/bin/presto-cli --server server1:9090 --catalog tpch</span><br><span class="line">presto:default&gt; SHOW SCHEMAS FROM tpch;</span><br><span class="line">       Schema       </span><br><span class="line">--------------------</span><br><span class="line"> information_schema </span><br><span class="line"> sf1                </span><br><span class="line"> sf100              </span><br><span class="line"> sf1000             </span><br><span class="line"> sf10000            </span><br><span class="line"> sf100000           </span><br><span class="line"> sf300              </span><br><span class="line"> sf3000             </span><br><span class="line"> sf30000            </span><br><span class="line"> tiny    </span><br><span class="line"></span><br><span class="line">presto:default&gt; use sf1;</span><br><span class="line">presto:sf1&gt; show tables;</span><br><span class="line">  Table   </span><br><span class="line">----------</span><br><span class="line"> customer </span><br><span class="line"> lineitem </span><br><span class="line"> nation   </span><br><span class="line"> orders   </span><br><span class="line"> part     </span><br><span class="line"> partsupp </span><br><span class="line"> region   </span><br><span class="line"> supplier</span><br></pre></td></tr></table></figure>
<h2 id="七、函数"><a href="#七、函数" class="headerlink" title="七、函数"></a>七、函数</h2><p><img src="https://www.itweet.cn/screenshots/function-color.png" alt><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://prestodb-china.com/docs/current/functions/color.html</span><br></pre></td></tr></table></figure></p>
<ul>
<li>时间函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">presto:default&gt; select &apos;2001-08-22 03:04:05&apos;,date_format(cast(&apos;2001-08-22 03:04:05&apos; as timestamp),&apos;%H%m&apos;) from default.event_type_jf limit 1;</span><br><span class="line">_col0        | _col1</span><br><span class="line">---------------------+-------</span><br><span class="line"> 2001-08-22 03:04:05 | 0308</span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">http://prestodb-china.com/docs/current/functions/datetime.html</span><br><span class="line"></span><br><span class="line">presto:default&gt; select &apos;2001-08-22 03:04:05&apos;,date_format(cast(&apos;2001-08-22 03:04:05&apos; as timestamp),&apos;%Y%m%d&apos;) from default.event_type_jf limit 1;</span><br><span class="line">_col0        |  _col1</span><br><span class="line">---------------------+----------</span><br><span class="line"> 2001-08-22 03:04:05 | 20010822</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="八、join性能"><a href="#八、join性能" class="headerlink" title="八、join性能"></a>八、join性能</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">join时有大表的话开启distributed-joins-enabled=true，并将大表放在join的右侧，会提高性能</span><br><span class="line">或者命令行里面set session distributed_join=&apos;true&apos;;</span><br><span class="line"></span><br><span class="line">配置文件</span><br><span class="line"># sample nodeId to provide consistency across test runs</span><br><span class="line">node.id=ffffffff-ffff-ffff-ffff-ffffffffffff</span><br><span class="line">node.environment=test</span><br><span class="line">http-server.http.port=8080</span><br><span class="line"></span><br><span class="line">discovery-server.enabled=true</span><br><span class="line">discovery.uri=http://localhost:8080</span><br><span class="line"></span><br><span class="line">exchange.http-client.max-connections=1000</span><br><span class="line">exchange.http-client.max-connections-per-server=1000</span><br><span class="line">exchange.http-client.connect-timeout=1m</span><br><span class="line">exchange.http-client.read-timeout=1m</span><br><span class="line"></span><br><span class="line">scheduler.http-client.max-connections=1000</span><br><span class="line">scheduler.http-client.max-connections-per-server=1000</span><br><span class="line">scheduler.http-client.connect-timeout=1m</span><br><span class="line">scheduler.http-client.read-timeout=1m</span><br><span class="line"></span><br><span class="line">query.client.timeout=5m</span><br><span class="line">query.max-age=30m</span><br><span class="line"></span><br><span class="line">plugin.bundles=\</span><br><span class="line">  ../presto-raptor/pom.xml,\</span><br><span class="line">  ../presto-hive-cdh4/pom.xml,\</span><br><span class="line">  ../presto-example-http/pom.xml,\</span><br><span class="line">  ../presto-kafka/pom.xml, \</span><br><span class="line">  ../presto-tpch/pom.xml</span><br><span class="line"></span><br><span class="line">presto.version=testversion</span><br><span class="line">experimental-syntax-enabled=true</span><br><span class="line">distributed-joins-enabled=true</span><br></pre></td></tr></table></figure>
<h2 id="队列相关"><a href="#队列相关" class="headerlink" title="队列相关"></a>队列相关</h2><p><a href="https://prestodb.io/docs/current/admin/queue.html" target="_blank" rel="noopener">https://prestodb.io/docs/current/admin/queue.html</a></p>
<h2 id="SQL语法"><a href="#SQL语法" class="headerlink" title="SQL语法"></a>SQL语法</h2><h3 id="1-3-显示分区表"><a href="#1-3-显示分区表" class="headerlink" title="1.3 显示分区表"></a>1.3 显示分区表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">presto:bigdata&gt; SHOW PARTITIONS FROM test_partitioned;</span><br></pre></td></tr></table></figure>
<h2 id="Presto-for-ambari"><a href="#Presto-for-ambari" class="headerlink" title="Presto for ambari"></a>Presto for ambari</h2><ul>
<li><a href="http://teradata.github.io/presto/docs/current/server-installation.html" target="_blank" rel="noopener">http://teradata.github.io/presto/docs/current/server-installation.html</a></li>
</ul>
<p>参考：<a href="https://prestodb.io/" target="_blank" rel="noopener">https://prestodb.io/</a></p>
<p>原创文章，转载请注明： 转载自<a href="http://www.itweet.cn" target="_blank" rel="noopener">Itweet</a>的博客<br><code>本博客的文章集合:</code> <a href="http://www.itweet.cn/blog/archive/" target="_blank" rel="noopener">http://www.itweet.cn/blog/archive/</a></p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/SQL/">SQL</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2015/07/24/yarn-resources-manager-allocation/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">yarn-resources-manager-allocation</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2015/07/20/tez-use/">
        <span class="next-text nav-default">tez-use</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2019
    <span class="footer-author">Xu Jiang.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/realXuJiang/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
