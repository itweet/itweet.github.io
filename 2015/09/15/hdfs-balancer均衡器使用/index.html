<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="hdfs-balancer均衡器使用">




  <meta name="keywords" content="hdfs,">





  <link rel="alternate" href="/atom.xml" title="WHOAMI">




  <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/itweet/itweet.github.io/master/favicon.ico?v=1.1">



<link rel="canonical" href="http://itweet.github.io/2015/09/15/hdfs-balancer均衡器使用/">


<meta name="description" content="简介 Hadoop的HDFS集群非常容易出现机器与机器之间磁盘利用率不平衡的情况，比如集群中添加新的数据节点。当HDFS出现不平衡状况的时候，将引发很多问题，比如MR程序无法很好地利用本地计算的优势，机器之间无法达到更好的网络带宽使用率，机器磁盘无法利用等等。可见，保证HDFS中的数据平衡是非常重要的。在Hadoop中，包含一个Balancer程序，通过运行这个程序，可以使得HDFS集群达到一个平">
<meta name="keywords" content="hdfs">
<meta property="og:type" content="article">
<meta property="og:title" content="hdfs-balancer均衡器使用">
<meta property="og:url" content="http://itweet.github.io/2015/09/15/hdfs-balancer均衡器使用/index.html">
<meta property="og:site_name" content="WHOAMI">
<meta property="og:description" content="简介 Hadoop的HDFS集群非常容易出现机器与机器之间磁盘利用率不平衡的情况，比如集群中添加新的数据节点。当HDFS出现不平衡状况的时候，将引发很多问题，比如MR程序无法很好地利用本地计算的优势，机器之间无法达到更好的网络带宽使用率，机器磁盘无法利用等等。可见，保证HDFS中的数据平衡是非常重要的。在Hadoop中，包含一个Balancer程序，通过运行这个程序，可以使得HDFS集群达到一个平">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-12-25T14:39:06.102Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hdfs-balancer均衡器使用">
<meta name="twitter:description" content="简介 Hadoop的HDFS集群非常容易出现机器与机器之间磁盘利用率不平衡的情况，比如集群中添加新的数据节点。当HDFS出现不平衡状况的时候，将引发很多问题，比如MR程序无法很好地利用本地计算的优势，机器之间无法达到更好的网络带宽使用率，机器磁盘无法利用等等。可见，保证HDFS中的数据平衡是非常重要的。在Hadoop中，包含一个Balancer程序，通过运行这个程序，可以使得HDFS集群达到一个平">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b75d841b3068f7782eac9af2c8c866e7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-154998721-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154998721-1');
</script>


    <title> hdfs-balancer均衡器使用 - WHOAMI </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">WHOAMI</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/atom.xml">
                            
                            
                                RSS
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          hdfs-balancer均衡器使用
        
      </h1>

      <time class="post-time">
          9月 15 2015
      </time>
    </header>



    
            <div class="post-content">
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><blockquote>
<p>Hadoop的HDFS集群非常容易出现机器与机器之间磁盘利用率不平衡的情况，比如集群中添<br>加新的数据节点。当HDFS出现不平衡状况的时候，将引发很多问题，比如MR程序无法很好<br>地利用本地计算的优势，机器之间无法达到更好的网络带宽使用率，机器磁盘无法利用等<br>等。可见，保证HDFS中的数据平衡是非常重要的。<br>在Hadoop中，包含一个Balancer程序，通过运行这个程序，可以使得HDFS集群达到一个平<br>衡的状态</p>
</blockquote>
<h1 id="Step1-balancer-command"><a href="#Step1-balancer-command" class="headerlink" title="Step1: balancer command"></a>Step1: balancer command</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">HDFS Balance</span><br><span class="line"> &gt;bin/start-balancer.sh -threshold 15</span><br><span class="line"> &gt;bin/stop-balancer.sh</span><br><span class="line"> &gt;各个DataNode存储不均匀时使用</span><br><span class="line"> -不同机器之间</span><br><span class="line"> -同机器不同磁盘之间无法通过这种方法balance</span><br><span class="line">&gt; dfs.balance.bandwidthPerSec(限制balance带宽)</span><br><span class="line"></span><br><span class="line">影响hadoop balance工具的几个参数：</span><br><span class="line">-threshold 默认设置：10，参数取值范围：0-100，参数含义：判断集群是否平衡的目标参数，每一个 datanode 存储使用率和集群总存储使用率的差值都应该小于这个阀值 ，理论上，该参数设置的越小，整个集群就越平衡，但是在线上环境中，hadoop集群在进行balance时，还在并发的进行数据的写入和删除，所以有可能无法到达设定的平衡参数值。</span><br><span class="line"></span><br><span class="line">dfs.balance.bandwidthPerSec  默认设置：1048576（1 M/S），参数含义：设置balance工具在运行中所能占用的带宽，设置的过大可能会造成mapred运行缓慢</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">/** &lt;p&gt;The balancer is a tool that balances disk space usage on an HDFS cluster </span><br><span class="line"> * when some datanodes become full or when new empty nodes join the cluster. </span><br><span class="line"> * The tool is deployed as an application program that can be run by the  </span><br><span class="line"> * cluster administrator on a live HDFS cluster while applications </span><br><span class="line"> * adding and deleting files. </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;SYNOPSIS </span><br><span class="line"> * &lt;pre&gt; </span><br><span class="line"> * To start: </span><br><span class="line"> *      bin/start-balancer.sh [-threshold &lt;threshold&gt;] </span><br><span class="line"> *      Example: bin/ start-balancer.sh  </span><br><span class="line"> *                     start the balancer with a default threshold of 10% </span><br><span class="line"> *               bin/ start-balancer.sh -threshold 5 </span><br><span class="line"> *                     start the balancer with a threshold of 5% </span><br><span class="line"> * To stop: </span><br><span class="line"> *      bin/ stop-balancer.sh </span><br><span class="line"> * &lt;/pre&gt; </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;DESCRIPTION </span><br><span class="line"> * &lt;p&gt;The threshold parameter is a fraction in the range of (1%, 100%) with a  </span><br><span class="line"> * default value of 10%. The threshold sets a target for whether the cluster  </span><br><span class="line"> * is balanced. A cluster is balanced if for each datanode, the utilization  </span><br><span class="line"> * of the node (ratio of used space at the node to total capacity of the node)  </span><br><span class="line"> * differs from the utilization of the (ratio of used space in the cluster  </span><br><span class="line"> * to total capacity of the cluster) by no more than the threshold value.  </span><br><span class="line"> * The smaller the threshold, the more balanced a cluster will become.  </span><br><span class="line"> * It takes more time to run the balancer for small threshold values.  </span><br><span class="line"> * Also for a very small threshold the cluster may not be able to reach the  </span><br><span class="line"> * balanced state when applications write and delete files concurrently. </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;The tool moves blocks from highly utilized datanodes to poorly  </span><br><span class="line"> * utilized datanodes iteratively. In each iteration a datanode moves or  </span><br><span class="line"> * receives no more than the lesser of 10G bytes or the threshold fraction  </span><br><span class="line"> * of its capacity. Each iteration runs no more than 20 minutes. </span><br><span class="line"> * 每次移动不超过10G大小，每次移动不超过20分钟。 </span><br><span class="line"> * At the end of each iteration, the balancer obtains updated datanodes </span><br><span class="line"> * information from the namenode. </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;A system property that limits the balancer&apos;s use of bandwidth is  </span><br><span class="line"> * defined in the default configuration file: </span><br><span class="line"> * &lt;pre&gt; </span><br><span class="line"> * &lt;property&gt; </span><br><span class="line"> *   &lt;name&gt;dfs.balance.bandwidthPerSec&lt;/name&gt; </span><br><span class="line"> *   &lt;value&gt;1048576&lt;/value&gt; </span><br><span class="line"> * &lt;description&gt;  Specifies the maximum bandwidth that each datanode  </span><br><span class="line"> * can utilize for the balancing purpose in term of the number of bytes  </span><br><span class="line"> * per second. &lt;/description&gt; </span><br><span class="line"> * &lt;/property&gt; </span><br><span class="line"> * &lt;/pre&gt; </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;This property determines the maximum speed at which a block will be  </span><br><span class="line"> * moved from one datanode to another. The default value is 1MB/s. The higher  </span><br><span class="line"> * the bandwidth, the faster a cluster can reach the balanced state,  </span><br><span class="line"> * but with greater competition with application processes. If an  </span><br><span class="line"> * administrator changes the value of this property in the configuration  </span><br><span class="line"> * file, the change is observed when HDFS is next restarted. </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;MONITERING BALANCER PROGRESS </span><br><span class="line"> * &lt;p&gt;After the balancer is started, an output file name where the balancer  </span><br><span class="line"> * progress will be recorded is printed on the screen.  The administrator  </span><br><span class="line"> * can monitor the running of the balancer by reading the output file.  </span><br><span class="line"> * The output shows the balancer&apos;s status iteration by iteration. In each  </span><br><span class="line"> * iteration it prints the starting time, the iteration number, the total  </span><br><span class="line"> * number of bytes that have been moved in the previous iterations,  </span><br><span class="line"> * the total number of bytes that are left to move in order for the cluster  </span><br><span class="line"> * to be balanced, and the number of bytes that are being moved in this  </span><br><span class="line"> * iteration. Normally &quot;Bytes Already Moved&quot; is increasing while &quot;Bytes Left  </span><br><span class="line"> * To Move&quot; is decreasing. </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;Running multiple instances of the balancer in an HDFS cluster is  </span><br><span class="line"> * prohibited by the tool. </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;The balancer automatically exits when any of the following five  </span><br><span class="line"> * conditions is satisfied: </span><br><span class="line"> * &lt;ol&gt; </span><br><span class="line"> * &lt;li&gt;The cluster is balanced; </span><br><span class="line"> * &lt;li&gt;No block can be moved; </span><br><span class="line"> * &lt;li&gt;No block has been moved for five consecutive(连续) iterations; </span><br><span class="line"> * &lt;li&gt;An IOException occurs while communicating with the namenode; </span><br><span class="line"> * &lt;li&gt;Another balancer is running. </span><br><span class="line"> * &lt;/ol&gt; </span><br><span class="line"> * 下面5种情况会导致Balance操作的失败 </span><br><span class="line"> * 1、整个集群已经达到平衡状态 </span><br><span class="line"> * 2、经过计算发现没有可以被移动的block块 </span><br><span class="line"> * 3、在连续5次的迭代中，没有block块被移动 </span><br><span class="line"> * 4、当datanode节点与namenode节点通信的时候，发生IO异常 </span><br><span class="line"> * 5、已经存在一个Balance操作 </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;Upon exit, a balancer returns an exit code and prints one of the  </span><br><span class="line"> * following messages to the output file in corresponding to the above exit  </span><br><span class="line"> * reasons: </span><br><span class="line"> * &lt;ol&gt; </span><br><span class="line"> * &lt;li&gt;The cluster is balanced. Exiting </span><br><span class="line"> * &lt;li&gt;No block can be moved. Exiting... </span><br><span class="line"> * &lt;li&gt;No block has been moved for 5 iterations. Exiting... </span><br><span class="line"> * &lt;li&gt;Received an IO exception: failure reason. Exiting... </span><br><span class="line"> * &lt;li&gt;Another balancer is running. Exiting... </span><br><span class="line"> * &lt;/ol&gt; </span><br><span class="line"> * 在下面的5种情况下，balancer操作会自动退出 </span><br><span class="line"> * 1、整个集群已经达到平衡的状态 </span><br><span class="line"> * 2、经过计算发现没有可以被移动block块 </span><br><span class="line"> * 3、在5论的迭代没有block被移动 </span><br><span class="line"> * 4、接收端发生了IO异常 </span><br><span class="line"> * 5、已经存在一个balanr进程在工作 </span><br><span class="line"> *  </span><br><span class="line"> * &lt;p&gt;The administrator can interrupt the execution of the balancer at any  </span><br><span class="line"> * time by running the command &quot;stop-balancer.sh&quot; on the machine where the  </span><br><span class="line"> * balancer is running. </span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<h1 id="Step2-balancer-源码"><a href="#Step2-balancer-源码" class="headerlink" title="Step2: balancer 源码"></a>Step2: balancer 源码</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Licensed to the Apache Software Foundation (ASF) under one</span><br><span class="line"> * or more contributor license agreements.  See the NOTICE file</span><br><span class="line"> * distributed with this work for additional information</span><br><span class="line"> * regarding copyright ownership.  The ASF licenses this file</span><br><span class="line"> * to you under the Apache License, Version 2.0 (the</span><br><span class="line"> * &quot;License&quot;); you may not use this file except in compliance</span><br><span class="line"> * with the License.  You may obtain a copy of the License at</span><br><span class="line"> *</span><br><span class="line"> *     http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line"> *</span><br><span class="line"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="line"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"> * See the License for the specific language governing permissions and</span><br><span class="line"> * limitations under the License.</span><br><span class="line"> */</span><br><span class="line">package org.apache.hadoop.hdfs.server.balancer;</span><br><span class="line"></span><br><span class="line">import static com.google.common.base.Preconditions.checkArgument;</span><br><span class="line"></span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.PrintStream;</span><br><span class="line">import java.net.URI;</span><br><span class="line">import java.text.DateFormat;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collection;</span><br><span class="line">import java.util.Collections;</span><br><span class="line">import java.util.Date;</span><br><span class="line">import java.util.Iterator;</span><br><span class="line">import java.util.LinkedList;</span><br><span class="line">import java.util.List;</span><br><span class="line">import java.util.Set;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.logging.Log;</span><br><span class="line">import org.apache.commons.logging.LogFactory;</span><br><span class="line">import org.apache.hadoop.classification.InterfaceAudience;</span><br><span class="line">import org.apache.hadoop.conf.Configuration;</span><br><span class="line">import org.apache.hadoop.conf.Configured;</span><br><span class="line">import org.apache.hadoop.fs.Path;</span><br><span class="line">import org.apache.hadoop.fs.StorageType;</span><br><span class="line">import org.apache.hadoop.hdfs.DFSConfigKeys;</span><br><span class="line">import org.apache.hadoop.hdfs.DFSUtil;</span><br><span class="line">import org.apache.hadoop.hdfs.HdfsConfiguration;</span><br><span class="line">import org.apache.hadoop.hdfs.server.balancer.Dispatcher.DDatanode;</span><br><span class="line">import org.apache.hadoop.hdfs.server.balancer.Dispatcher.DDatanode.StorageGroup;</span><br><span class="line">import org.apache.hadoop.hdfs.server.balancer.Dispatcher.Source;</span><br><span class="line">import org.apache.hadoop.hdfs.server.balancer.Dispatcher.Task;</span><br><span class="line">import org.apache.hadoop.hdfs.server.balancer.Dispatcher.Util;</span><br><span class="line">import org.apache.hadoop.hdfs.server.blockmanagement.BlockPlacementPolicy;</span><br><span class="line">import org.apache.hadoop.hdfs.server.blockmanagement.BlockPlacementPolicyDefault;</span><br><span class="line">import org.apache.hadoop.hdfs.server.namenode.UnsupportedActionException;</span><br><span class="line">import org.apache.hadoop.hdfs.server.protocol.DatanodeStorageReport;</span><br><span class="line">import org.apache.hadoop.hdfs.server.protocol.StorageReport;</span><br><span class="line">import org.apache.hadoop.io.IOUtils;</span><br><span class="line">import org.apache.hadoop.util.StringUtils;</span><br><span class="line">import org.apache.hadoop.util.Time;</span><br><span class="line">import org.apache.hadoop.util.Tool;</span><br><span class="line">import org.apache.hadoop.util.ToolRunner;</span><br><span class="line"></span><br><span class="line">import com.google.common.base.Preconditions;</span><br><span class="line"></span><br><span class="line">/** &lt;p&gt;The balancer is a tool that balances disk space usage on an HDFS cluster</span><br><span class="line"> * when some datanodes become full or when new empty nodes join the cluster.</span><br><span class="line"> * The tool is deployed as an application program that can be run by the </span><br><span class="line"> * cluster administrator on a live HDFS cluster while applications</span><br><span class="line"> * adding and deleting files.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;SYNOPSIS</span><br><span class="line"> * &lt;pre&gt;</span><br><span class="line"> * To start:</span><br><span class="line"> *      bin/start-balancer.sh [-threshold &lt;threshold&gt;]</span><br><span class="line"> *      Example: bin/ start-balancer.sh </span><br><span class="line"> *                     start the balancer with a default threshold of 10%</span><br><span class="line"> *               bin/ start-balancer.sh -threshold 5</span><br><span class="line"> *                     start the balancer with a threshold of 5%</span><br><span class="line"> *               bin/ start-balancer.sh -idleiterations 20</span><br><span class="line"> *                     start the balancer with maximum 20 consecutive idle iterations</span><br><span class="line"> *               bin/ start-balancer.sh -idleiterations -1</span><br><span class="line"> *                     run the balancer with default threshold infinitely</span><br><span class="line"> * To stop:</span><br><span class="line"> *      bin/ stop-balancer.sh</span><br><span class="line"> * &lt;/pre&gt;</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;DESCRIPTION</span><br><span class="line"> * &lt;p&gt;The threshold parameter is a fraction in the range of (1%, 100%) with a </span><br><span class="line"> * default value of 10%. The threshold sets a target for whether the cluster </span><br><span class="line"> * is balanced. A cluster is balanced if for each datanode, the utilization </span><br><span class="line"> * of the node (ratio of used space at the node to total capacity of the node) </span><br><span class="line"> * differs from the utilization of the (ratio of used space in the cluster </span><br><span class="line"> * to total capacity of the cluster) by no more than the threshold value. </span><br><span class="line"> * The smaller the threshold, the more balanced a cluster will become. </span><br><span class="line"> * It takes more time to run the balancer for small threshold values. </span><br><span class="line"> * Also for a very small threshold the cluster may not be able to reach the </span><br><span class="line"> * balanced state when applications write and delete files concurrently.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;The tool moves blocks from highly utilized datanodes to poorly </span><br><span class="line"> * utilized datanodes iteratively. In each iteration a datanode moves or </span><br><span class="line"> * receives no more than the lesser of 10G bytes or the threshold fraction </span><br><span class="line"> * of its capacity. Each iteration runs no more than 20 minutes.</span><br><span class="line"> * At the end of each iteration, the balancer obtains updated datanodes</span><br><span class="line"> * information from the namenode.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;A system property that limits the balancer&apos;s use of bandwidth is </span><br><span class="line"> * defined in the default configuration file:</span><br><span class="line"> * &lt;pre&gt;</span><br><span class="line"> * &lt;property&gt;</span><br><span class="line"> *   &lt;name&gt;dfs.balance.bandwidthPerSec&lt;/name&gt;</span><br><span class="line"> *   &lt;value&gt;1048576&lt;/value&gt;</span><br><span class="line"> * &lt;description&gt;  Specifies the maximum bandwidth that each datanode </span><br><span class="line"> * can utilize for the balancing purpose in term of the number of bytes </span><br><span class="line"> * per second. &lt;/description&gt;</span><br><span class="line"> * &lt;/property&gt;</span><br><span class="line"> * &lt;/pre&gt;</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;This property determines the maximum speed at which a block will be </span><br><span class="line"> * moved from one datanode to another. The default value is 1MB/s. The higher </span><br><span class="line"> * the bandwidth, the faster a cluster can reach the balanced state, </span><br><span class="line"> * but with greater competition with application processes. If an </span><br><span class="line"> * administrator changes the value of this property in the configuration </span><br><span class="line"> * file, the change is observed when HDFS is next restarted.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;MONITERING BALANCER PROGRESS</span><br><span class="line"> * &lt;p&gt;After the balancer is started, an output file name where the balancer </span><br><span class="line"> * progress will be recorded is printed on the screen.  The administrator </span><br><span class="line"> * can monitor the running of the balancer by reading the output file. </span><br><span class="line"> * The output shows the balancer&apos;s status iteration by iteration. In each </span><br><span class="line"> * iteration it prints the starting time, the iteration number, the total </span><br><span class="line"> * number of bytes that have been moved in the previous iterations, </span><br><span class="line"> * the total number of bytes that are left to move in order for the cluster </span><br><span class="line"> * to be balanced, and the number of bytes that are being moved in this </span><br><span class="line"> * iteration. Normally &quot;Bytes Already Moved&quot; is increasing while &quot;Bytes Left </span><br><span class="line"> * To Move&quot; is decreasing.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;Running multiple instances of the balancer in an HDFS cluster is </span><br><span class="line"> * prohibited by the tool.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;The balancer automatically exits when any of the following five </span><br><span class="line"> * conditions is satisfied:</span><br><span class="line"> * &lt;ol&gt;</span><br><span class="line"> * &lt;li&gt;The cluster is balanced;</span><br><span class="line"> * &lt;li&gt;No block can be moved;</span><br><span class="line"> * &lt;li&gt;No block has been moved for specified consecutive iterations (5 by default);</span><br><span class="line"> * &lt;li&gt;An IOException occurs while communicating with the namenode;</span><br><span class="line"> * &lt;li&gt;Another balancer is running.</span><br><span class="line"> * &lt;/ol&gt;</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;Upon exit, a balancer returns an exit code and prints one of the </span><br><span class="line"> * following messages to the output file in corresponding to the above exit </span><br><span class="line"> * reasons:</span><br><span class="line"> * &lt;ol&gt;</span><br><span class="line"> * &lt;li&gt;The cluster is balanced. Exiting</span><br><span class="line"> * &lt;li&gt;No block can be moved. Exiting...</span><br><span class="line"> * &lt;li&gt;No block has been moved for specified iterations (5 by default). Exiting...</span><br><span class="line"> * &lt;li&gt;Received an IO exception: failure reason. Exiting...</span><br><span class="line"> * &lt;li&gt;Another balancer is running. Exiting...</span><br><span class="line"> * &lt;/ol&gt;</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;The administrator can interrupt the execution of the balancer at any </span><br><span class="line"> * time by running the command &quot;stop-balancer.sh&quot; on the machine where the </span><br><span class="line"> * balancer is running.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">@InterfaceAudience.Private</span><br><span class="line">public class Balancer &#123;</span><br><span class="line">  static final Log LOG = LogFactory.getLog(Balancer.class);</span><br><span class="line"></span><br><span class="line">  static final Path BALANCER_ID_PATH = new Path(&quot;/system/balancer.id&quot;);</span><br><span class="line"></span><br><span class="line">  private static final long GB = 1L &lt;&lt; 30; //1GB</span><br><span class="line">  private static final long MAX_SIZE_TO_MOVE = 10*GB;</span><br><span class="line"></span><br><span class="line">  private static final String USAGE = &quot;Usage: hdfs balancer&quot;</span><br><span class="line">      + &quot;\n\t[-policy &lt;policy&gt;]\tthe balancing policy: &quot;</span><br><span class="line">      + BalancingPolicy.Node.INSTANCE.getName() + &quot; or &quot;</span><br><span class="line">      + BalancingPolicy.Pool.INSTANCE.getName()</span><br><span class="line">      + &quot;\n\t[-threshold &lt;threshold&gt;]\tPercentage of disk capacity&quot;</span><br><span class="line">      + &quot;\n\t[-exclude [-f &lt;hosts-file&gt; | &lt;comma-separated list of hosts&gt;]]&quot;</span><br><span class="line">      + &quot;\tExcludes the specified datanodes.&quot;</span><br><span class="line">      + &quot;\n\t[-include [-f &lt;hosts-file&gt; | &lt;comma-separated list of hosts&gt;]]&quot;</span><br><span class="line">      + &quot;\tIncludes only the specified datanodes.&quot;</span><br><span class="line">      + &quot;\n\t[-idleiterations &lt;idleiterations&gt;]&quot;</span><br><span class="line">      + &quot;\tNumber of consecutive idle iterations (-1 for Infinite) before &quot;</span><br><span class="line">      + &quot;exit.&quot;</span><br><span class="line">      + &quot;\n\t[-runDuringUpgrade]&quot;</span><br><span class="line">      + &quot;\tWhether to run the balancer during an ongoing HDFS upgrade.&quot;</span><br><span class="line">      + &quot;This is usually not desired since it will not affect used space &quot;</span><br><span class="line">      + &quot;on over-utilized machines.&quot;;</span><br><span class="line"></span><br><span class="line">  private final Dispatcher dispatcher;</span><br><span class="line">  private final NameNodeConnector nnc;</span><br><span class="line">  private final BalancingPolicy policy;</span><br><span class="line">  private final boolean runDuringUpgrade;</span><br><span class="line">  private final double threshold;</span><br><span class="line"></span><br><span class="line">  // all data node lists</span><br><span class="line">  private final Collection&lt;Source&gt; overUtilized = new LinkedList&lt;Source&gt;();</span><br><span class="line">  private final Collection&lt;Source&gt; aboveAvgUtilized = new LinkedList&lt;Source&gt;();</span><br><span class="line">  private final Collection&lt;StorageGroup&gt; belowAvgUtilized</span><br><span class="line">      = new LinkedList&lt;StorageGroup&gt;();</span><br><span class="line">  private final Collection&lt;StorageGroup&gt; underUtilized</span><br><span class="line">      = new LinkedList&lt;StorageGroup&gt;();</span><br><span class="line"></span><br><span class="line">  /* Check that this Balancer is compatible with the Block Placement Policy</span><br><span class="line">   * used by the Namenode.</span><br><span class="line">   */</span><br><span class="line">  private static void checkReplicationPolicyCompatibility(Configuration conf</span><br><span class="line">      ) throws UnsupportedActionException &#123;</span><br><span class="line">    if (!(BlockPlacementPolicy.getInstance(conf, null, null, null) instanceof </span><br><span class="line">        BlockPlacementPolicyDefault)) &#123;</span><br><span class="line">      throw new UnsupportedActionException(</span><br><span class="line">          &quot;Balancer without BlockPlacementPolicyDefault&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Construct a balancer.</span><br><span class="line">   * Initialize balancer. It sets the value of the threshold, and </span><br><span class="line">   * builds the communication proxies to</span><br><span class="line">   * namenode as a client and a secondary namenode and retry proxies</span><br><span class="line">   * when connection fails.</span><br><span class="line">   */</span><br><span class="line">  Balancer(NameNodeConnector theblockpool, Parameters p, Configuration conf) &#123;</span><br><span class="line">    final long movedWinWidth = conf.getLong(</span><br><span class="line">        DFSConfigKeys.DFS_BALANCER_MOVEDWINWIDTH_KEY,</span><br><span class="line">        DFSConfigKeys.DFS_BALANCER_MOVEDWINWIDTH_DEFAULT);</span><br><span class="line">    final int moverThreads = conf.getInt(</span><br><span class="line">        DFSConfigKeys.DFS_BALANCER_MOVERTHREADS_KEY,</span><br><span class="line">        DFSConfigKeys.DFS_BALANCER_MOVERTHREADS_DEFAULT);</span><br><span class="line">    final int dispatcherThreads = conf.getInt(</span><br><span class="line">        DFSConfigKeys.DFS_BALANCER_DISPATCHERTHREADS_KEY,</span><br><span class="line">        DFSConfigKeys.DFS_BALANCER_DISPATCHERTHREADS_DEFAULT);</span><br><span class="line">    final int maxConcurrentMovesPerNode = conf.getInt(</span><br><span class="line">        DFSConfigKeys.DFS_DATANODE_BALANCE_MAX_NUM_CONCURRENT_MOVES_KEY,</span><br><span class="line">        DFSConfigKeys.DFS_DATANODE_BALANCE_MAX_NUM_CONCURRENT_MOVES_DEFAULT);</span><br><span class="line"></span><br><span class="line">    this.nnc = theblockpool;</span><br><span class="line">    this.dispatcher = new Dispatcher(theblockpool, p.nodesToBeIncluded,</span><br><span class="line">        p.nodesToBeExcluded, movedWinWidth, moverThreads, dispatcherThreads,</span><br><span class="line">        maxConcurrentMovesPerNode, conf);</span><br><span class="line">    this.threshold = p.threshold;</span><br><span class="line">    this.policy = p.policy;</span><br><span class="line">    this.runDuringUpgrade = p.runDuringUpgrade;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  private static long getCapacity(DatanodeStorageReport report, StorageType t) &#123;</span><br><span class="line">    long capacity = 0L;</span><br><span class="line">    for(StorageReport r : report.getStorageReports()) &#123;</span><br><span class="line">      if (r.getStorage().getStorageType() == t) &#123;</span><br><span class="line">        capacity += r.getCapacity();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return capacity;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private static long getRemaining(DatanodeStorageReport report, StorageType t) &#123;</span><br><span class="line">    long remaining = 0L;</span><br><span class="line">    for(StorageReport r : report.getStorageReports()) &#123;</span><br><span class="line">      if (r.getStorage().getStorageType() == t) &#123;</span><br><span class="line">        remaining += r.getRemaining();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return remaining;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Given a datanode storage set, build a network topology and decide</span><br><span class="line">   * over-utilized storages, above average utilized storages, </span><br><span class="line">   * below average utilized storages, and underutilized storages. </span><br><span class="line">   * The input datanode storage set is shuffled in order to randomize</span><br><span class="line">   * to the storage matching later on.</span><br><span class="line">   *</span><br><span class="line">   * @return the number of bytes needed to move in order to balance the cluster.</span><br><span class="line">   */</span><br><span class="line">  private long init(List&lt;DatanodeStorageReport&gt; reports) &#123;</span><br><span class="line">    // compute average utilization</span><br><span class="line">    for (DatanodeStorageReport r : reports) &#123;</span><br><span class="line">      policy.accumulateSpaces(r);</span><br><span class="line">    &#125;</span><br><span class="line">    policy.initAvgUtilization();</span><br><span class="line"></span><br><span class="line">    // create network topology and classify utilization collections: </span><br><span class="line">    //   over-utilized, above-average, below-average and under-utilized.</span><br><span class="line">    long overLoadedBytes = 0L, underLoadedBytes = 0L;</span><br><span class="line">    for(DatanodeStorageReport r : reports) &#123;</span><br><span class="line">      final DDatanode dn = dispatcher.newDatanode(r.getDatanodeInfo());</span><br><span class="line">      for(StorageType t : StorageType.getMovableTypes()) &#123;</span><br><span class="line">        final Double utilization = policy.getUtilization(r, t);</span><br><span class="line">        if (utilization == null) &#123; // datanode does not have such storage type </span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        final long capacity = getCapacity(r, t);</span><br><span class="line">        final double utilizationDiff = utilization - policy.getAvgUtilization(t);</span><br><span class="line">        final double thresholdDiff = Math.abs(utilizationDiff) - threshold;</span><br><span class="line">        final long maxSize2Move = computeMaxSize2Move(capacity,</span><br><span class="line">            getRemaining(r, t), utilizationDiff, threshold);</span><br><span class="line"></span><br><span class="line">        final StorageGroup g;</span><br><span class="line">        if (utilizationDiff &gt; 0) &#123;</span><br><span class="line">          final Source s = dn.addSource(t, maxSize2Move, dispatcher);</span><br><span class="line">          if (thresholdDiff &lt;= 0) &#123; // within threshold</span><br><span class="line">            aboveAvgUtilized.add(s);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            overLoadedBytes += percentage2bytes(thresholdDiff, capacity);</span><br><span class="line">            overUtilized.add(s);</span><br><span class="line">          &#125;</span><br><span class="line">          g = s;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          g = dn.addTarget(t, maxSize2Move);</span><br><span class="line">          if (thresholdDiff &lt;= 0) &#123; // within threshold</span><br><span class="line">            belowAvgUtilized.add(g);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            underLoadedBytes += percentage2bytes(thresholdDiff, capacity);</span><br><span class="line">            underUtilized.add(g);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dispatcher.getStorageGroupMap().put(g);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    logUtilizationCollections();</span><br><span class="line">    </span><br><span class="line">    Preconditions.checkState(dispatcher.getStorageGroupMap().size()</span><br><span class="line">        == overUtilized.size() + underUtilized.size() + aboveAvgUtilized.size()</span><br><span class="line">           + belowAvgUtilized.size(),</span><br><span class="line">        &quot;Mismatched number of storage groups&quot;);</span><br><span class="line">    </span><br><span class="line">    // return number of bytes to be moved in order to make the cluster balanced</span><br><span class="line">    return Math.max(overLoadedBytes, underLoadedBytes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private static long computeMaxSize2Move(final long capacity, final long remaining,</span><br><span class="line">      final double utilizationDiff, final double threshold) &#123;</span><br><span class="line">    final double diff = Math.min(threshold, Math.abs(utilizationDiff));</span><br><span class="line">    long maxSizeToMove = percentage2bytes(diff, capacity);</span><br><span class="line">    if (utilizationDiff &lt; 0) &#123;</span><br><span class="line">      maxSizeToMove = Math.min(remaining, maxSizeToMove);</span><br><span class="line">    &#125;</span><br><span class="line">    return Math.min(MAX_SIZE_TO_MOVE, maxSizeToMove);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private static long percentage2bytes(double percentage, long capacity) &#123;</span><br><span class="line">    Preconditions.checkArgument(percentage &gt;= 0, &quot;percentage = %s &lt; 0&quot;,</span><br><span class="line">        percentage);</span><br><span class="line">    return (long)(percentage * capacity / 100.0);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* log the over utilized &amp; under utilized nodes */</span><br><span class="line">  private void logUtilizationCollections() &#123;</span><br><span class="line">    logUtilizationCollection(&quot;over-utilized&quot;, overUtilized);</span><br><span class="line">    if (LOG.isTraceEnabled()) &#123;</span><br><span class="line">      logUtilizationCollection(&quot;above-average&quot;, aboveAvgUtilized);</span><br><span class="line">      logUtilizationCollection(&quot;below-average&quot;, belowAvgUtilized);</span><br><span class="line">    &#125;</span><br><span class="line">    logUtilizationCollection(&quot;underutilized&quot;, underUtilized);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private static &lt;T extends StorageGroup&gt;</span><br><span class="line">      void logUtilizationCollection(String name, Collection&lt;T&gt; items) &#123;</span><br><span class="line">    LOG.info(items.size() + &quot; &quot; + name + &quot;: &quot; + items);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Decide all &lt;source, target&gt; pairs and</span><br><span class="line">   * the number of bytes to move from a source to a target</span><br><span class="line">   * Maximum bytes to be moved per storage group is</span><br><span class="line">   * min(1 Band worth of bytes,  MAX_SIZE_TO_MOVE).</span><br><span class="line">   * @return total number of bytes to move in this iteration</span><br><span class="line">   */</span><br><span class="line">  private long chooseStorageGroups() &#123;</span><br><span class="line">    // First, match nodes on the same node group if cluster is node group aware</span><br><span class="line">    if (dispatcher.getCluster().isNodeGroupAware()) &#123;</span><br><span class="line">      chooseStorageGroups(Matcher.SAME_NODE_GROUP);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Then, match nodes on the same rack</span><br><span class="line">    chooseStorageGroups(Matcher.SAME_RACK);</span><br><span class="line">    // At last, match all remaining nodes</span><br><span class="line">    chooseStorageGroups(Matcher.ANY_OTHER);</span><br><span class="line">    </span><br><span class="line">    return dispatcher.bytesToMove();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /** Decide all &lt;source, target&gt; pairs according to the matcher. */</span><br><span class="line">  private void chooseStorageGroups(final Matcher matcher) &#123;</span><br><span class="line">    /* first step: match each overUtilized datanode (source) to</span><br><span class="line">     * one or more underUtilized datanodes (targets).</span><br><span class="line">     */</span><br><span class="line">    chooseStorageGroups(overUtilized, underUtilized, matcher);</span><br><span class="line">    </span><br><span class="line">    /* match each remaining overutilized datanode (source) to </span><br><span class="line">     * below average utilized datanodes (targets).</span><br><span class="line">     * Note only overutilized datanodes that haven&apos;t had that max bytes to move</span><br><span class="line">     * satisfied in step 1 are selected</span><br><span class="line">     */</span><br><span class="line">    chooseStorageGroups(overUtilized, belowAvgUtilized, matcher);</span><br><span class="line"></span><br><span class="line">    /* match each remaining underutilized datanode (target) to </span><br><span class="line">     * above average utilized datanodes (source).</span><br><span class="line">     * Note only underutilized datanodes that have not had that max bytes to</span><br><span class="line">     * move satisfied in step 1 are selected.</span><br><span class="line">     */</span><br><span class="line">    chooseStorageGroups(underUtilized, aboveAvgUtilized, matcher);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * For each datanode, choose matching nodes from the candidates. Either the</span><br><span class="line">   * datanodes or the candidates are source nodes with (utilization &gt; Avg), and</span><br><span class="line">   * the others are target nodes with (utilization &lt; Avg).</span><br><span class="line">   */</span><br><span class="line">  private &lt;G extends StorageGroup, C extends StorageGroup&gt;</span><br><span class="line">      void chooseStorageGroups(Collection&lt;G&gt; groups, Collection&lt;C&gt; candidates,</span><br><span class="line">          Matcher matcher) &#123;</span><br><span class="line">    for(final Iterator&lt;G&gt; i = groups.iterator(); i.hasNext();) &#123;</span><br><span class="line">      final G g = i.next();</span><br><span class="line">      for(; choose4One(g, candidates, matcher); );</span><br><span class="line">      if (!g.hasSpaceForScheduling()) &#123;</span><br><span class="line">        i.remove();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * For the given datanode, choose a candidate and then schedule it.</span><br><span class="line">   * @return true if a candidate is chosen; false if no candidates is chosen.</span><br><span class="line">   */</span><br><span class="line">  private &lt;C extends StorageGroup&gt; boolean choose4One(StorageGroup g,</span><br><span class="line">      Collection&lt;C&gt; candidates, Matcher matcher) &#123;</span><br><span class="line">    final Iterator&lt;C&gt; i = candidates.iterator();</span><br><span class="line">    final C chosen = chooseCandidate(g, i, matcher);</span><br><span class="line">  </span><br><span class="line">    if (chosen == null) &#123;</span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">    if (g instanceof Source) &#123;</span><br><span class="line">      matchSourceWithTargetToMove((Source)g, chosen);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      matchSourceWithTargetToMove((Source)chosen, g);</span><br><span class="line">    &#125;</span><br><span class="line">    if (!chosen.hasSpaceForScheduling()) &#123;</span><br><span class="line">      i.remove();</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  private void matchSourceWithTargetToMove(Source source, StorageGroup target) &#123;</span><br><span class="line">    long size = Math.min(source.availableSizeToMove(), target.availableSizeToMove());</span><br><span class="line">    final Task task = new Task(target, size);</span><br><span class="line">    source.addTask(task);</span><br><span class="line">    target.incScheduledSize(task.getSize());</span><br><span class="line">    dispatcher.add(source, target);</span><br><span class="line">    LOG.info(&quot;Decided to move &quot;+StringUtils.byteDesc(size)+&quot; bytes from &quot;</span><br><span class="line">        + source.getDisplayName() + &quot; to &quot; + target.getDisplayName());</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  /** Choose a candidate for the given datanode. */</span><br><span class="line">  private &lt;G extends StorageGroup, C extends StorageGroup&gt;</span><br><span class="line">      C chooseCandidate(G g, Iterator&lt;C&gt; candidates, Matcher matcher) &#123;</span><br><span class="line">    if (g.hasSpaceForScheduling()) &#123;</span><br><span class="line">      for(; candidates.hasNext(); ) &#123;</span><br><span class="line">        final C c = candidates.next();</span><br><span class="line">        if (!c.hasSpaceForScheduling()) &#123;</span><br><span class="line">          candidates.remove();</span><br><span class="line">        &#125; else if (matcher.match(dispatcher.getCluster(),</span><br><span class="line">            g.getDatanodeInfo(), c.getDatanodeInfo())) &#123;</span><br><span class="line">          return c;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* reset all fields in a balancer preparing for the next iteration */</span><br><span class="line">  void resetData(Configuration conf) &#123;</span><br><span class="line">    this.overUtilized.clear();</span><br><span class="line">    this.aboveAvgUtilized.clear();</span><br><span class="line">    this.belowAvgUtilized.clear();</span><br><span class="line">    this.underUtilized.clear();</span><br><span class="line">    this.policy.reset();</span><br><span class="line">    dispatcher.reset(conf);;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static class Result &#123;</span><br><span class="line">    final ExitStatus exitStatus;</span><br><span class="line">    final long bytesLeftToMove;</span><br><span class="line">    final long bytesBeingMoved;</span><br><span class="line">    final long bytesAlreadyMoved;</span><br><span class="line"></span><br><span class="line">    Result(ExitStatus exitStatus, long bytesLeftToMove, long bytesBeingMoved,</span><br><span class="line">        long bytesAlreadyMoved) &#123;</span><br><span class="line">      this.exitStatus = exitStatus;</span><br><span class="line">      this.bytesLeftToMove = bytesLeftToMove;</span><br><span class="line">      this.bytesBeingMoved = bytesBeingMoved;</span><br><span class="line">      this.bytesAlreadyMoved = bytesAlreadyMoved;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void print(int iteration, PrintStream out) &#123;</span><br><span class="line">      out.printf(&quot;%-24s %10d  %19s  %18s  %17s%n&quot;,</span><br><span class="line">          DateFormat.getDateTimeInstance().format(new Date()), iteration,</span><br><span class="line">          StringUtils.byteDesc(bytesAlreadyMoved),</span><br><span class="line">          StringUtils.byteDesc(bytesLeftToMove),</span><br><span class="line">          StringUtils.byteDesc(bytesBeingMoved));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Result newResult(ExitStatus exitStatus, long bytesLeftToMove, long bytesBeingMoved) &#123;</span><br><span class="line">    return new Result(exitStatus, bytesLeftToMove, bytesBeingMoved,</span><br><span class="line">        dispatcher.getBytesMoved());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Result newResult(ExitStatus exitStatus) &#123;</span><br><span class="line">    return new Result(exitStatus, -1, -1, dispatcher.getBytesMoved());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /** Run an iteration for all datanodes. */</span><br><span class="line">  Result runOneIteration() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      final List&lt;DatanodeStorageReport&gt; reports = dispatcher.init();</span><br><span class="line">      final long bytesLeftToMove = init(reports);</span><br><span class="line">      if (bytesLeftToMove == 0) &#123;</span><br><span class="line">        System.out.println(&quot;The cluster is balanced. Exiting...&quot;);</span><br><span class="line">        return newResult(ExitStatus.SUCCESS, bytesLeftToMove, -1);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        LOG.info( &quot;Need to move &quot;+ StringUtils.byteDesc(bytesLeftToMove)</span><br><span class="line">            + &quot; to make the cluster balanced.&quot; );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Should not run the balancer during an unfinalized upgrade, since moved</span><br><span class="line">      // blocks are not deleted on the source datanode.</span><br><span class="line">      if (!runDuringUpgrade &amp;&amp; nnc.isUpgrading()) &#123;</span><br><span class="line">        return newResult(ExitStatus.UNFINALIZED_UPGRADE, bytesLeftToMove, -1);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      /* Decide all the nodes that will participate in the block move and</span><br><span class="line">       * the number of bytes that need to be moved from one node to another</span><br><span class="line">       * in this iteration. Maximum bytes to be moved per node is</span><br><span class="line">       * Min(1 Band worth of bytes,  MAX_SIZE_TO_MOVE).</span><br><span class="line">       */</span><br><span class="line">      final long bytesBeingMoved = chooseStorageGroups();</span><br><span class="line">      if (bytesBeingMoved == 0) &#123;</span><br><span class="line">        System.out.println(&quot;No block can be moved. Exiting...&quot;);</span><br><span class="line">        return newResult(ExitStatus.NO_MOVE_BLOCK, bytesLeftToMove, bytesBeingMoved);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        LOG.info( &quot;Will move &quot; + StringUtils.byteDesc(bytesBeingMoved) +</span><br><span class="line">            &quot; in this iteration&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      /* For each pair of &lt;source, target&gt;, start a thread that repeatedly </span><br><span class="line">       * decide a block to be moved and its proxy source, </span><br><span class="line">       * then initiates the move until all bytes are moved or no more block</span><br><span class="line">       * available to move.</span><br><span class="line">       * Exit no byte has been moved for 5 consecutive iterations.</span><br><span class="line">       */</span><br><span class="line">      if (!dispatcher.dispatchAndCheckContinue()) &#123;</span><br><span class="line">        return newResult(ExitStatus.NO_MOVE_PROGRESS, bytesLeftToMove, bytesBeingMoved);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return newResult(ExitStatus.IN_PROGRESS, bytesLeftToMove, bytesBeingMoved);</span><br><span class="line">    &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">      System.out.println(e + &quot;.  Exiting ...&quot;);</span><br><span class="line">      return newResult(ExitStatus.ILLEGAL_ARGUMENTS);</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">      System.out.println(e + &quot;.  Exiting ...&quot;);</span><br><span class="line">      return newResult(ExitStatus.IO_EXCEPTION);</span><br><span class="line">    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">      System.out.println(e + &quot;.  Exiting ...&quot;);</span><br><span class="line">      return newResult(ExitStatus.INTERRUPTED);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      dispatcher.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Balance all namenodes.</span><br><span class="line">   * For each iteration,</span><br><span class="line">   * for each namenode,</span><br><span class="line">   * execute a &#123;@link Balancer&#125; to work through all datanodes once.  </span><br><span class="line">   */</span><br><span class="line">  static int run(Collection&lt;URI&gt; namenodes, final Parameters p,</span><br><span class="line">      Configuration conf) throws IOException, InterruptedException &#123;</span><br><span class="line">    final long sleeptime =</span><br><span class="line">        conf.getLong(DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_KEY,</span><br><span class="line">            DFSConfigKeys.DFS_HEARTBEAT_INTERVAL_DEFAULT) * 2000 +</span><br><span class="line">        conf.getLong(DFSConfigKeys.DFS_NAMENODE_REPLICATION_INTERVAL_KEY,</span><br><span class="line">            DFSConfigKeys.DFS_NAMENODE_REPLICATION_INTERVAL_DEFAULT) * 1000;</span><br><span class="line">    LOG.info(&quot;namenodes  = &quot; + namenodes);</span><br><span class="line">    LOG.info(&quot;parameters = &quot; + p);</span><br><span class="line">    </span><br><span class="line">    System.out.println(&quot;Time Stamp               Iteration#  Bytes Already Moved  Bytes Left To Move  Bytes Being Moved&quot;);</span><br><span class="line">    </span><br><span class="line">    List&lt;NameNodeConnector&gt; connectors = Collections.emptyList();</span><br><span class="line">    try &#123;</span><br><span class="line">      connectors = NameNodeConnector.newNameNodeConnectors(namenodes, </span><br><span class="line">            Balancer.class.getSimpleName(), BALANCER_ID_PATH, conf, p.maxIdleIteration);</span><br><span class="line">    </span><br><span class="line">      boolean done = false;</span><br><span class="line">      for(int iteration = 0; !done; iteration++) &#123;</span><br><span class="line">        done = true;</span><br><span class="line">        Collections.shuffle(connectors);</span><br><span class="line">        for(NameNodeConnector nnc : connectors) &#123;</span><br><span class="line">          final Balancer b = new Balancer(nnc, p, conf);</span><br><span class="line">          final Result r = b.runOneIteration();</span><br><span class="line">          r.print(iteration, System.out);</span><br><span class="line"></span><br><span class="line">          // clean all lists</span><br><span class="line">          b.resetData(conf);</span><br><span class="line">          if (r.exitStatus == ExitStatus.IN_PROGRESS) &#123;</span><br><span class="line">            done = false;</span><br><span class="line">          &#125; else if (r.exitStatus != ExitStatus.SUCCESS) &#123;</span><br><span class="line">            //must be an error statue, return.</span><br><span class="line">            return r.exitStatus.getExitCode();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!done) &#123;</span><br><span class="line">          Thread.sleep(sleeptime);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">      for(NameNodeConnector nnc : connectors) &#123;</span><br><span class="line">        IOUtils.cleanup(LOG, nnc);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return ExitStatus.SUCCESS.getExitCode();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* Given elaspedTime in ms, return a printable string */</span><br><span class="line">  private static String time2Str(long elapsedTime) &#123;</span><br><span class="line">    String unit;</span><br><span class="line">    double time = elapsedTime;</span><br><span class="line">    if (elapsedTime &lt; 1000) &#123;</span><br><span class="line">      unit = &quot;milliseconds&quot;;</span><br><span class="line">    &#125; else if (elapsedTime &lt; 60*1000) &#123;</span><br><span class="line">      unit = &quot;seconds&quot;;</span><br><span class="line">      time = time/1000;</span><br><span class="line">    &#125; else if (elapsedTime &lt; 3600*1000) &#123;</span><br><span class="line">      unit = &quot;minutes&quot;;</span><br><span class="line">      time = time/(60*1000);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      unit = &quot;hours&quot;;</span><br><span class="line">      time = time/(3600*1000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return time+&quot; &quot;+unit;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static class Parameters &#123;</span><br><span class="line">    static final Parameters DEFAULT = new Parameters(</span><br><span class="line">        BalancingPolicy.Node.INSTANCE, 10.0,</span><br><span class="line">        NameNodeConnector.DEFAULT_MAX_IDLE_ITERATIONS,</span><br><span class="line">        Collections.&lt;String&gt; emptySet(), Collections.&lt;String&gt; emptySet(),</span><br><span class="line">        false);</span><br><span class="line"></span><br><span class="line">    final BalancingPolicy policy;</span><br><span class="line">    final double threshold;</span><br><span class="line">    final int maxIdleIteration;</span><br><span class="line">    // exclude the nodes in this set from balancing operations</span><br><span class="line">    Set&lt;String&gt; nodesToBeExcluded;</span><br><span class="line">    //include only these nodes in balancing operations</span><br><span class="line">    Set&lt;String&gt; nodesToBeIncluded;</span><br><span class="line">    /**</span><br><span class="line">     * Whether to run the balancer during upgrade.</span><br><span class="line">     */</span><br><span class="line">    final boolean runDuringUpgrade;</span><br><span class="line"></span><br><span class="line">    Parameters(BalancingPolicy policy, double threshold, int maxIdleIteration,</span><br><span class="line">        Set&lt;String&gt; nodesToBeExcluded, Set&lt;String&gt; nodesToBeIncluded,</span><br><span class="line">        boolean runDuringUpgrade) &#123;</span><br><span class="line">      this.policy = policy;</span><br><span class="line">      this.threshold = threshold;</span><br><span class="line">      this.maxIdleIteration = maxIdleIteration;</span><br><span class="line">      this.nodesToBeExcluded = nodesToBeExcluded;</span><br><span class="line">      this.nodesToBeIncluded = nodesToBeIncluded;</span><br><span class="line">      this.runDuringUpgrade = runDuringUpgrade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">      return String.format(&quot;%s.%s [%s,&quot;</span><br><span class="line">              + &quot; threshold = %s,&quot;</span><br><span class="line">              + &quot; max idle iteration = %s, &quot;</span><br><span class="line">              + &quot;number of nodes to be excluded = %s,&quot;</span><br><span class="line">              + &quot; number of nodes to be included = %s,&quot;</span><br><span class="line">              + &quot; run during upgrade = %s]&quot;,</span><br><span class="line">          Balancer.class.getSimpleName(), getClass().getSimpleName(),</span><br><span class="line">          policy, threshold, maxIdleIteration,</span><br><span class="line">          nodesToBeExcluded.size(), nodesToBeIncluded.size(),</span><br><span class="line">          runDuringUpgrade);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  static class Cli extends Configured implements Tool &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Parse arguments and then run Balancer.</span><br><span class="line">     * </span><br><span class="line">     * @param args command specific arguments.</span><br><span class="line">     * @return exit code. 0 indicates success, non-zero indicates failure.</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public int run(String[] args) &#123;</span><br><span class="line">      final long startTime = Time.monotonicNow();</span><br><span class="line">      final Configuration conf = getConf();</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">        checkReplicationPolicyCompatibility(conf);</span><br><span class="line"></span><br><span class="line">        final Collection&lt;URI&gt; namenodes = DFSUtil.getNsServiceRpcUris(conf);</span><br><span class="line">        return Balancer.run(namenodes, parse(args), conf);</span><br><span class="line">      &#125; catch (IOException e) &#123;</span><br><span class="line">        System.out.println(e + &quot;.  Exiting ...&quot;);</span><br><span class="line">        return ExitStatus.IO_EXCEPTION.getExitCode();</span><br><span class="line">      &#125; catch (InterruptedException e) &#123;</span><br><span class="line">        System.out.println(e + &quot;.  Exiting ...&quot;);</span><br><span class="line">        return ExitStatus.INTERRUPTED.getExitCode();</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        System.out.format(&quot;%-24s &quot;,</span><br><span class="line">            DateFormat.getDateTimeInstance().format(new Date()));</span><br><span class="line">        System.out.println(&quot;Balancing took &quot;</span><br><span class="line">            + time2Str(Time.monotonicNow() - startTime));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /** parse command line arguments */</span><br><span class="line">    static Parameters parse(String[] args) &#123;</span><br><span class="line">      BalancingPolicy policy = Parameters.DEFAULT.policy;</span><br><span class="line">      double threshold = Parameters.DEFAULT.threshold;</span><br><span class="line">      int maxIdleIteration = Parameters.DEFAULT.maxIdleIteration;</span><br><span class="line">      Set&lt;String&gt; nodesTobeExcluded = Parameters.DEFAULT.nodesToBeExcluded;</span><br><span class="line">      Set&lt;String&gt; nodesTobeIncluded = Parameters.DEFAULT.nodesToBeIncluded;</span><br><span class="line">      boolean runDuringUpgrade = Parameters.DEFAULT.runDuringUpgrade;</span><br><span class="line"></span><br><span class="line">      if (args != null) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">          for(int i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">            if (&quot;-threshold&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">              checkArgument(++i &lt; args.length,</span><br><span class="line">                &quot;Threshold value is missing: args = &quot; + Arrays.toString(args));</span><br><span class="line">              try &#123;</span><br><span class="line">                threshold = Double.parseDouble(args[i]);</span><br><span class="line">                if (threshold &lt; 1 || threshold &gt; 100) &#123;</span><br><span class="line">                  throw new IllegalArgumentException(</span><br><span class="line">                      &quot;Number out of range: threshold = &quot; + threshold);</span><br><span class="line">                &#125;</span><br><span class="line">                LOG.info( &quot;Using a threshold of &quot; + threshold );</span><br><span class="line">              &#125; catch(IllegalArgumentException e) &#123;</span><br><span class="line">                System.err.println(</span><br><span class="line">                    &quot;Expecting a number in the range of [1.0, 100.0]: &quot;</span><br><span class="line">                    + args[i]);</span><br><span class="line">                throw e;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; else if (&quot;-policy&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">              checkArgument(++i &lt; args.length,</span><br><span class="line">                &quot;Policy value is missing: args = &quot; + Arrays.toString(args));</span><br><span class="line">              try &#123;</span><br><span class="line">                policy = BalancingPolicy.parse(args[i]);</span><br><span class="line">              &#125; catch(IllegalArgumentException e) &#123;</span><br><span class="line">                System.err.println(&quot;Illegal policy name: &quot; + args[i]);</span><br><span class="line">                throw e;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; else if (&quot;-exclude&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">              checkArgument(++i &lt; args.length,</span><br><span class="line">                  &quot;List of nodes to exclude | -f &lt;filename&gt; is missing: args = &quot;</span><br><span class="line">                  + Arrays.toString(args));</span><br><span class="line">              if (&quot;-f&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">                checkArgument(++i &lt; args.length,</span><br><span class="line">                    &quot;File containing nodes to exclude is not specified: args = &quot;</span><br><span class="line">                    + Arrays.toString(args));</span><br><span class="line">                nodesTobeExcluded = Util.getHostListFromFile(args[i], &quot;exclude&quot;);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                nodesTobeExcluded = Util.parseHostList(args[i]);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; else if (&quot;-include&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">              checkArgument(++i &lt; args.length,</span><br><span class="line">                &quot;List of nodes to include | -f &lt;filename&gt; is missing: args = &quot;</span><br><span class="line">                + Arrays.toString(args));</span><br><span class="line">              if (&quot;-f&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">                checkArgument(++i &lt; args.length,</span><br><span class="line">                    &quot;File containing nodes to include is not specified: args = &quot;</span><br><span class="line">                    + Arrays.toString(args));</span><br><span class="line">                nodesTobeIncluded = Util.getHostListFromFile(args[i], &quot;include&quot;);</span><br><span class="line">               &#125; else &#123;</span><br><span class="line">                nodesTobeIncluded = Util.parseHostList(args[i]);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; else if (&quot;-idleiterations&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">              checkArgument(++i &lt; args.length,</span><br><span class="line">                  &quot;idleiterations value is missing: args = &quot; + Arrays</span><br><span class="line">                      .toString(args));</span><br><span class="line">              maxIdleIteration = Integer.parseInt(args[i]);</span><br><span class="line">              LOG.info(&quot;Using a idleiterations of &quot; + maxIdleIteration);</span><br><span class="line">            &#125; else if (&quot;-runDuringUpgrade&quot;.equalsIgnoreCase(args[i])) &#123;</span><br><span class="line">              runDuringUpgrade = true;</span><br><span class="line">              LOG.info(&quot;Will run the balancer even during an ongoing HDFS &quot;</span><br><span class="line">                  + &quot;upgrade. Most users will not want to run the balancer &quot;</span><br><span class="line">                  + &quot;during an upgrade since it will not affect used space &quot;</span><br><span class="line">                  + &quot;on over-utilized machines.&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              throw new IllegalArgumentException(&quot;args = &quot;</span><br><span class="line">                  + Arrays.toString(args));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          checkArgument(nodesTobeExcluded.isEmpty() || nodesTobeIncluded.isEmpty(),</span><br><span class="line">              &quot;-exclude and -include options cannot be specified together.&quot;);</span><br><span class="line">        &#125; catch(RuntimeException e) &#123;</span><br><span class="line">          printUsage(System.err);</span><br><span class="line">          throw e;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      return new Parameters(policy, threshold, maxIdleIteration,</span><br><span class="line">          nodesTobeExcluded, nodesTobeIncluded, runDuringUpgrade);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void printUsage(PrintStream out) &#123;</span><br><span class="line">      out.println(USAGE + &quot;\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * Run a balancer</span><br><span class="line">   * @param args Command line arguments</span><br><span class="line">   */</span><br><span class="line">  public static void main(String[] args) &#123;</span><br><span class="line">    if (DFSUtil.parseHelpArgument(args, USAGE, System.out, true)) &#123;</span><br><span class="line">      System.exit(0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    try &#123;</span><br><span class="line">      System.exit(ToolRunner.run(new HdfsConfiguration(), new Cli(), args));</span><br><span class="line">    &#125; catch (Throwable e) &#123;</span><br><span class="line">      LOG.error(&quot;Exiting balancer due an exception&quot;, e);</span><br><span class="line">      System.exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/hdfs/">hdfs</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2015/09/21/Apache-Cassandra-Cluster/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Apache-Cassandra-Cluster</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2015/08/31/Ambari离线安装HDP-Hadoop集群/">
        <span class="next-text nav-default">Ambari离线安装HDP-Hadoop集群</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
    <div style="text-align:center;">
        <button class="btn" id="load-disqus" onclick="disqus.load();">加载 Disqus 评论</button>
    </div>
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2023
    <span class="footer-author">Xu Jiang.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/realXuJiang/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    

<script type="text/javascript">
  var disqus_shortname = 'itweet-cn';
  var disqus_identifier = '2015/09/15/hdfs-balancer均衡器使用/';

  var disqus_title = "hdfs-balancer均衡器使用";


  var disqus = {
    load : function disqus(){
        if(typeof DISQUS !== 'object') {
          (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
          }());
          $('#load-disqus').remove(); ///加载后移除按钮
        }
    }
  }

  
    var disqus_config = function () {
        this.page.url = disqus_url;
        this.page.identifier = disqus_identifier;
        this.page.title = disqus_title;
    };
  

</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
