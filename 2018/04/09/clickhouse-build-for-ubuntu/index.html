<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.8.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="clickhouse-build-for-ubuntu">




  <meta name="keywords" content="Clickhouse,">





  <link rel="alternate" href="/atom.xml" title="WHOAMI">




  <link rel="shortcut icon" type="image/x-icon" href="https://raw.githubusercontent.com/itweet/itweet.github.io/master/favicon.ico?v=1.1">



<link rel="canonical" href="http://itweet.github.io/2018/04/09/clickhouse-build-for-ubuntu/">


<meta name="description" content="ClickHouse源码阅读环境之Ubuntu编译，主要介绍如何在Ubuntu 17版本成功构建ClickHouse，生成可部署的二进制文件。 基于Ubuntu 17编译ClickHouse获取Ubuntu 17.10版本，并且运行此版本镜像，把宿主机/data/gitlab/jdp目录挂载到容器/opt目录。 通过docker exec命令进入容器，执行相关编译操作。 123docker run">
<meta name="keywords" content="Clickhouse">
<meta property="og:type" content="article">
<meta property="og:title" content="clickhouse-build-for-ubuntu">
<meta property="og:url" content="http://itweet.github.io/2018/04/09/clickhouse-build-for-ubuntu/index.html">
<meta property="og:site_name" content="WHOAMI">
<meta property="og:description" content="ClickHouse源码阅读环境之Ubuntu编译，主要介绍如何在Ubuntu 17版本成功构建ClickHouse，生成可部署的二进制文件。 基于Ubuntu 17编译ClickHouse获取Ubuntu 17.10版本，并且运行此版本镜像，把宿主机/data/gitlab/jdp目录挂载到容器/opt目录。 通过docker exec命令进入容器，执行相关编译操作。 123docker run">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/itweet/labs/raw/master/common/img/weixin_public.gif">
<meta property="og:updated_time" content="2018-07-02T13:09:15.534Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="clickhouse-build-for-ubuntu">
<meta name="twitter:description" content="ClickHouse源码阅读环境之Ubuntu编译，主要介绍如何在Ubuntu 17版本成功构建ClickHouse，生成可部署的二进制文件。 基于Ubuntu 17编译ClickHouse获取Ubuntu 17.10版本，并且运行此版本镜像，把宿主机/data/gitlab/jdp目录挂载到容器/opt目录。 通过docker exec命令进入容器，执行相关编译操作。 123docker run">
<meta name="twitter:image" content="https://github.com/itweet/labs/raw/master/common/img/weixin_public.gif">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> clickhouse-build-for-ubuntu - WHOAMI </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">WHOAMI</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
                    <li class="menu-item">
                        <a href="/atom.xml">
                            
                            
                                RSS
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          clickhouse-build-for-ubuntu
        
      </h1>

      <time class="post-time">
          4月 09 2018
      </time>
    </header>



    
            <div class="post-content">
            <p>ClickHouse源码阅读环境之Ubuntu编译，主要介绍如何在Ubuntu 17版本成功构建ClickHouse，生成可部署的二进制文件。</p>
<h2 id="基于Ubuntu-17编译ClickHouse"><a href="#基于Ubuntu-17编译ClickHouse" class="headerlink" title="基于Ubuntu 17编译ClickHouse"></a>基于Ubuntu 17编译ClickHouse</h2><p>获取Ubuntu 17.10版本，并且运行此版本镜像，把宿主机/data/gitlab/jdp目录挂载到容器/opt目录。 通过docker exec命令进入容器，执行相关编译操作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd -v /data/gitlab/jdp:/opt --workdir /opt ubuntu:17.10 /bin/bash</span><br><span class="line"></span><br><span class="line">docker exec -it angry_edison /bin/bash</span><br></pre></td></tr></table></figure>
<p>接下来就是容器内的操作，为了方便，一般我在我的Ubuntu和macos机器上都是通过docker来跑各种系统和测试的，基本当做虚拟机用，关于docker知识查阅资料吧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/issue</span><br><span class="line">Ubuntu 17.10</span><br><span class="line"></span><br><span class="line"># uname -ar</span><br><span class="line">Linux 88fb00182673 4.9.60-linuxkit-aufs #1 SMP Mon Nov 6 16:00:12 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>
<p>在Ubuntu 17.10容器中安装相关编译环境软件包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt update -y </span><br><span class="line"></span><br><span class="line">apt install -y cmake libssl-dev libcrypto++-dev libglib2.0-dev libltdl-dev libicu-dev libmysql++-dev libreadline-dev libmysqlclient-dev unixodbc-dev gcc-7 g++-7 unixodbc-dev devscripts dupload fakeroot debhelper liblld-5.0-dev libclang-5.0-dev liblld-5.0</span><br></pre></td></tr></table></figure>
<p>进入宿主机映射容器目录，为了持久化保存编译目录数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /opt</span><br><span class="line">git clone -b stable --recursive https://github.com/yandex/ClickHouse.git</span><br><span class="line"></span><br><span class="line">cd ClickHouse</span><br></pre></td></tr></table></figure>
<p>开始编译ClickHouse</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p build</span><br><span class="line"></span><br><span class="line">cd build</span><br><span class="line"></span><br><span class="line">cmake .. -DENABLE_EMBEDDED_COMPILER=1 -DENABLE_TESTS=0</span><br><span class="line"></span><br><span class="line">make -j $(nproc || grep -c ^processor /proc/cpuinfo)</span><br></pre></td></tr></table></figure>
<p>编译成功 - 尾部信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[100%] Linking CXX static library libclickhouse-benchmark-lib.a</span><br><span class="line">[100%] Built target clickhouse-benchmark-lib</span><br><span class="line">Scanning dependencies of target clickhouse-local-lib</span><br><span class="line">[100%] Building CXX object dbms/src/Server/CMakeFiles/clickhouse-local-lib.dir/LocalServer.cpp.o</span><br><span class="line">[100%] Linking CXX static library libclickhouse-copier-lib.a</span><br><span class="line">[100%] Built target clickhouse-copier-lib</span><br><span class="line">[100%] Linking CXX static library libclickhouse-local-lib.a</span><br><span class="line">[100%] Built target clickhouse-local-lib</span><br><span class="line">Scanning dependencies of target clickhouse</span><br><span class="line">[100%] Building CXX object dbms/src/Server/CMakeFiles/clickhouse.dir/main.cpp.o</span><br><span class="line">[100%] Linking CXX executable clickhouse</span><br><span class="line">[100%] Built target clickhouse</span><br><span class="line">Scanning dependencies of target clickhouse-lld</span><br><span class="line">Scanning dependencies of target clickhouse-extract-from-config</span><br><span class="line">[100%] Built target clickhouse-lld</span><br><span class="line">[100%] Built target clickhouse-extract-from-config</span><br><span class="line">Scanning dependencies of target clickhouse-clang</span><br><span class="line">Scanning dependencies of target clickhouse-copier</span><br><span class="line">[100%] Built target clickhouse-copier</span><br><span class="line">[100%] Built target clickhouse-clang</span><br><span class="line">Scanning dependencies of target clickhouse-format</span><br><span class="line">Scanning dependencies of target clickhouse-compressor</span><br><span class="line">[100%] Built target clickhouse-format</span><br><span class="line">[100%] Built target clickhouse-compressor</span><br><span class="line">Scanning dependencies of target clickhouse-benchmark</span><br><span class="line">Scanning dependencies of target clickhouse-server</span><br><span class="line">[100%] Built target clickhouse-benchmark</span><br><span class="line">[100%] Built target clickhouse-server</span><br><span class="line">Scanning dependencies of target clickhouse-client</span><br><span class="line">Scanning dependencies of target clickhouse-local</span><br><span class="line">[100%] Built target clickhouse-client</span><br><span class="line">[100%] Built target clickhouse-local</span><br><span class="line">Scanning dependencies of target clickhouse-performance-test</span><br><span class="line">[100%] Built target clickhouse-performance-test</span><br><span class="line">Scanning dependencies of target clickhouse-bundle</span><br><span class="line">[100%] Built target clickhouse-bundle</span><br></pre></td></tr></table></figure>
<p>为了便于使用，我把上述编译环境变成镜像已经上传到jikelab仓库，你可以通过如下命令获取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull jikelab/ubuntu-17.10-clickhouse:v1.1.54370-stable</span><br><span class="line"></span><br><span class="line">docker run -itd -v /data/gitlab/jdp:/opt --workdir /opt jikelab/ubuntu-17.10-clickhouse:v1.1.54370-stable /bin/bash</span><br><span class="line"></span><br><span class="line">docker exec -it 容器ID /bin/bash   # 进入容器后，clone源码，即可开始building...</span><br></pre></td></tr></table></figure>
<p>我是如何制作此镜像呢？</p>
<p>Examples:</p>
<p>Push一个新的image到公共镜像仓库。</p>
<p>[1] 通过正在运行的容器ID快速保存成新的镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker commit c16378f943fe ubuntu-17.10-clickhouse:v1.1.54370-stable</span><br></pre></td></tr></table></figure>
<p>[2] 现在通过image ID Push镜像到公共镜像仓库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker tag ubuntu-17.10-clickhouse:v1.1.54370-stable jikelab/ubuntu-17.10-clickhouse:v1.1.54370-stable</span><br><span class="line"></span><br><span class="line">$ docker push jikelab/ubuntu-17.10-clickhouse:v1.1.54370-stable</span><br></pre></td></tr></table></figure>
<p>[3] 通过运行如下命令检查镜像生成是否生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images</span><br></pre></td></tr></table></figure>
<p>你应该能看到<code>ubuntu-17.10-clickhouse:v1.1.54370-stable</code>和<code>jikelab/ubuntu-17.10-clickhouse:v1.1.54370-stable</code>镜像列表。</p>
<p>关于ClickHouse源码阅读环境之Centos编译</p>
<blockquote>
<p>正在整理相关编译环境和文档，会通过自动化的持续集成平台发布，可关注镜像仓库。</p>
</blockquote>
<p>关于构建deb包</p>
<blockquote>
<p>类似rm -f ../clickhouse<em>.deb &amp;&amp; ./release &amp;&amp; ls -l ../clickhouse</em>.deb命令，然后，愉快的部署和调试ClickHouse。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">export CMAKE=cmake</span><br><span class="line">export PREFIX=/data</span><br><span class="line"></span><br><span class="line">DAEMONS=&quot;clickhouse clickhouse-test clickhouse-compressor clickhouse-client clickhouse-server&quot;</span><br><span class="line">for daemon in $DAEMONS; do \</span><br><span class="line">        DESTDIR=$PREFIX $CMAKE -DCOMPONENT=$daemon -P cmake_install.cmake; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>小试一下CK</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse server --config=/data/usr/local/etc/clickhouse-server/config.xml</span><br></pre></td></tr></table></figure>
<p>启动报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Logging trace to console</span><br><span class="line">Poco::Exception. Code: 1000, e.code() = 0, e.displayText() = Exception: Could not determine local time zone: boost::filesystem::canonical: No such file or directory: &quot;/usr/share/zoneinfo/&quot;, e.what() = Exception</span><br></pre></td></tr></table></figure>
<p>解决</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install --reinstall tzdata</span><br><span class="line"></span><br><span class="line">dpkg-reconfigure tzdata   //根据提示选择时区，因为我是在docker编译和运行测试</span><br></pre></td></tr></table></figure>
<p>clickhouse CLI</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client -h 127.0.0.1 -d default</span><br><span class="line"></span><br><span class="line">b5c8238c1618 :) select count(*) from system.clusters;</span><br><span class="line"></span><br><span class="line">SELECT count(*)</span><br><span class="line">FROM system.clusters</span><br><span class="line"></span><br><span class="line">┌─count()─┐</span><br><span class="line">│       2 │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line">1 rows in set. Elapsed: 0.007 sec.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">b5c8238c1618 :) use default;</span><br></pre></td></tr></table></figure>
<p>Table测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE ontime_local (FlightDate Date,Year UInt16) ENGINE = MergeTree(FlightDate, (Year, FlightDate), 8192);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into ontime_local (FlightDate,Year)values(&apos;2001-10-12&apos;,2001);</span><br><span class="line"></span><br><span class="line">insert into ontime_local (FlightDate,Year)values(&apos;2002-10-12&apos;,2002);</span><br><span class="line"></span><br><span class="line">insert into ontime_local (FlightDate,Year)values(&apos;2003-10-12&apos;,2003);</span><br><span class="line"></span><br><span class="line">select count(*) from ontime_all;</span><br></pre></td></tr></table></figure></p>
<p>接下来，就愉快的进行代码开发，debug吧。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>介绍clickhouse在Ubuntu中进行源码编译和涉及到的Docker容器相关技术，对于想深入源码研究clickhouse的人来说，此步骤后就可以愉快的阅读代码，调试和改代码啦，简单看了一下clickhouse的代码量还是相当惊人的，相当于2个大型的C++项目，不得不佩服开发者，是在短短几年内完成的工作，而且还能保证测试覆盖率和高性能，那是相当厉害。</p>
<p>参考：</p>
<p>[1] <a href="https://docs.docker.com/engine/reference/commandline/push/#examples" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/commandline/push/#examples</a><br>[2] <a href="https://clickhouse.yandex/docs/en/development/build/" target="_blank" rel="noopener">https://clickhouse.yandex/docs/en/development/build/</a></p>
<p>欢迎关注微信公众号[Whoami]，阅读更多内容。<br><img src="https://github.com/itweet/labs/raw/master/common/img/weixin_public.gif" alt="Whoami公众号"></p>
<p>原创文章，转载请注明： 转载自<a href="http://www.itweet.cn" target="_blank" rel="noopener">Itweet</a>的博客<br><code>本博客的文章集合:</code> <a href="http://www.itweet.cn/blog/archive" target="_blank" rel="noopener">http://www.itweet.cn/blog/archive</a></p>

            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/Clickhouse/">Clickhouse</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/04/10/clickhouse-build-for-centos/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">clickhouse-build-for-centos</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2018/04/09/clickhouse-configuration-analyse/">
        <span class="next-text nav-default">clickhouse-configuration-analyse</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2014 -
    
    2019
    <span class="footer-author">Xu Jiang.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
